<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 transition-colors duration-300"
     :class="darkMode ? 'bg-gray-900' : 'bg-gray-100'">
  
  <!-- Toggle Dark Mode Button -->
  <button 
    @click="toggleDarkMode"
    class="absolute top-4 right-4 p-2 rounded-full bg-white dark:bg-gray-800 shadow-md hover:scale-110 transition-transform z-10 focus:outline-none focus:ring-2 focus:ring-primary"
    :title="darkMode ? 'Disattiva modalità scura' : 'Attiva modalità scura'"
    aria-label="Cambia modalità chiara/scura"
  >
    <i class="fas fa-moon text-gray-700 dark:text-yellow-400" x-show="!darkMode"></i>
    <i class="fas fa-sun text-yellow-400" x-show="darkMode" x-cloak></i>
  </button>

  <div 
    :class="darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'" 
    class="max-w-md w-full space-y-8 p-8 rounded-2xl shadow-xl mx-auto transition-colors duration-300"
  >
    <!-- Logo -->
    <div class="text-center">
      <a href="/" class="inline-block focus:outline-none focus:ring-2 focus:ring-primary rounded-lg">
        <img 
          :src="darkMode ? '/media/lb-logo-w.svg' : '/media/linkbay_logo.svg'" 
          width="180" 
          alt="Logo LinkBay-CMS" 
          class="mx-auto"
        >
      </a>
    </div>
      
    <!-- Titolo -->
    <div class="text-center">
      <h2 class="text-3xl font-bold" :class="darkMode ? 'text-white' : 'text-gray-900'">Crea il tuo Workspace</h2>
      <p class="mt-2 text-sm" :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Registrati per iniziare a utilizzare LinkBay-CMS</p>
    </div>
      
    <!-- Form Registrazione -->
    <div x-data="signupForm()" class="mt-8">
      <form class="space-y-6" @submit.prevent="register" novalidate>
        <template x-if="Object.keys(errors).length">
          <div 
            class="bg-red-50 dark:bg-red-900/20 p-4 rounded-md border border-red-200 dark:border-red-800"
            role="alert"
            aria-live="polite"
          >
            <template x-for="error in Object.values(errors)" :key="error">
              <p x-text="error" class="text-red-600 dark:text-red-400 text-sm"></p>
            </template>
          </div>
        </template>
        
        <!-- Workspace Name -->
        <div>
          <label for="workspaceName" class="block text-sm font-medium mb-1 sr-only">Nome Workspace</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-globe" :class="darkMode ? 'text-gray-400' : 'text-gray-400'"></i>
            </div>
            <input 
              id="workspaceName" 
              name="workspaceName" 
              type="text" 
              required
              class="block w-full pl-10 pr-24 py-3 border rounded-t-md sm:text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              :class="darkMode ? 
                'border-gray-600 bg-gray-700 placeholder-gray-400 text-white' : 
                'border-gray-300 placeholder-gray-500 text-gray-900'"
              placeholder="Nome del tuo workspace"
              x-model="workspaceName"
              @input.debounce.500ms="checkWorkspaceAvailability"
              :aria-invalid="errors.workspaceName ? 'true' : 'false'"
              aria-describedby="workspaceNameHelp"
            >
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <span :class="darkMode ? 'text-gray-400' : 'text-gray-500'">.linkbaycms.com</span>
            </div>
          </div>
          
          <!-- Keep legacy subdomain field for backend compatibility -->
          <input type="hidden" name="subdomain" :value="workspaceName">

          <!-- Validation / Availability messages -->
          <div id="workspaceNameHelp" class="mt-2 text-sm min-h-5">
            <p 
              x-show="errors.workspaceName" 
              x-text="errors.workspaceName" 
              class="text-red-500 dark:text-red-400" 
              x-cloak
            ></p>
            <p 
              x-show="checkingWorkspace" 
              class="text-gray-500 dark:text-gray-400 flex items-center" 
              x-cloak
            >
              <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
              </svg>
              Verifica disponibilità...
            </p>
            <p 
              x-show="workspaceAvailable === true" 
              class="text-green-600 dark:text-green-400 flex items-center"
            >
              <i class="fas fa-check-circle mr-1"></i> Nome disponibile
            </p>
            <p 
              x-show="workspaceAvailable === false" 
              class="text-red-500 dark:text-red-400 flex items-center"
            >
              <i class="fas fa-times-circle mr-1"></i> Nome già in uso
            </p>
          </div>
        </div>

        <!-- Email -->
        <div>
          <label for="email" class="block text-sm font-medium mb-1 sr-only">Email</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-envelope" :class="darkMode ? 'text-gray-400' : 'text-gray-400'"></i>
            </div>
            <input 
              id="email" 
              name="email" 
              type="email" 
              x-model="email"
              required 
              class="block w-full pl-10 pr-3 py-3 border border-t-0 sm:text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              :class="darkMode ? 
                'border-gray-600 bg-gray-700 placeholder-gray-400 text-white' : 
                'border-gray-300 placeholder-gray-500 text-gray-900'"
              placeholder="email@esempio.com"
              :aria-invalid="errors.email ? 'true' : 'false'"
            >
          </div>
          <p 
            x-show="errors.email" 
            x-text="errors.email" 
            class="text-red-500 dark:text-red-400 mt-1 text-sm" 
            x-cloak
          ></p>
        </div>

        <!-- Password -->
        <div>
          <label for="password" class="block text-sm font-medium mb-1 sr-only">Password</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-lock" :class="darkMode ? 'text-gray-400' : 'text-gray-400'"></i>
            </div>
            <input 
              id="password" 
              name="password" 
              type="password" 
              x-model="password"
              required 
              class="block w-full pl-10 pr-3 py-3 border border-t-0 rounded-b-md sm:text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              :class="darkMode ? 
                'border-gray-600 bg-gray-700 placeholder-gray-400 text-white' : 
                'border-gray-300 placeholder-gray-500 text-gray-900'"
              placeholder="Password"
              :aria-invalid="errors.password ? 'true' : 'false'"
            >
          </div>
          <p 
            x-show="errors.password" 
            x-text="errors.password" 
            class="text-red-500 dark:text-red-400 mt-1 text-sm" 
            x-cloak
          ></p>
        </div>

        <div>
          <button 
            type="submit" 
            class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
            :class="darkMode ? 'focus:ring-offset-gray-800' : 'focus:ring-offset-white'"
            :disabled="isLoading || checkingWorkspace"
          >
            <span class="absolute left-0 inset-y-0 flex items-center pl-3">
              <i 
                class="fas fa-plus-circle text-white" 
                :class="{ 'fa-spinner animate-spin': isLoading, 'fa-plus-circle': !isLoading }"
              ></i>
            </span>
            <span x-show="!isLoading">Crea Workspace</span>
            <span x-show="isLoading" x-cloak>Creazione in corso...</span>
          </button>
        </div>
      </form>
    </div>
      
    <!-- Divisore -->
    <div class="relative mt-6">
      <div class="absolute inset-0 flex items-center">
        <div class="w-full border-t" :class="darkMode ? 'border-gray-700' : 'border-gray-300'"></div>
      </div>
      <div class="relative flex justify-center text-sm">
        <span class="px-2" :class="darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-500'">OPPURE</span>
      </div>
    </div>
      
    <!-- Registrazione Social -->
    <div class="mt-6">
      <p class="text-center text-sm mb-3" :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Registrati con il tuo account</p>
      <div class="grid grid-cols-3 gap-3">
        <!-- Google Workspace -->
        <a 
          href="/auth/google" 
          class="w-full inline-flex justify-center items-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium transition-colors duration-200 hover-scale focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          :class="darkMode ? 
            'border-gray-700 bg-gray-700 text-white hover:bg-gray-600 focus:ring-offset-gray-800' : 
            'border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-offset-white'"
        >
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTcuNiA5LjJsLS4xLTEuOEg5djMuNGg0LjhDMTMuNiAxMiAxMyAxMyAxMiAxMy42djIuMmgzYTguOCA4LjggMCAwIDAgMi42LTYuNnoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjxwYXRoIGQ9Ik05IDE4YzIuNCAwIDQuNS0uOCA2LTIuMmwtMy0yLjJhNS40IDUuNCAwIDAgMS04LTIuOUgxVjEzYTkgOSAwIDAgMCA4IDV6IiBmaWxsPSIjMzRBODUzIiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNIDQgMTAuN2E1LjQgNS40IDAgMCAxIDAtMy40VjVIMS45YzAtLjAyLjEtLjA1LjEtLjA1YTkgOSAwIDAgMCAwIDhsMy0yLjN6IiBmaWxsPSIjRkJCQzA1IiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNOSAzLjZjMS4zIDAgMi41LjQgMy40IDEuM0wxNSAyLjNBOSA5IDAgMCAwIDEgNWwzIDIuNGE1LjQgNS40IDAgMCAxIDUtMy43eiIgZmlsbD0iI0VBNDMzNSIgZmlsbC1ydWxlPSJub256ZXJvIi8+PHBhdGggZD0iTTAgMGgxOHYxOEgweiIvPjwvZz48L3N2Zz4=" 
          alt="Google" 
          class="h-5 w-5"
        >
        </a>
              
        <!-- GitHub -->
        <a 
          href="/auth/github" 
          class="w-full inline-flex justify-center items-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium transition-colors duration-200 hover-scale focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          :class="darkMode ? 
            'border-gray-700 bg-gray-700 text-white hover:bg-gray-600 focus:ring-offset-gray-800' : 
            'border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-offset-white'"
        >
          <i class="fab fa-github text-lg" :class="darkMode ? 'text-white' : 'text-gray-800'"></i>
        </a>
              
        <!-- Microsoft -->
        <a 
          href="/auth/microsoft" 
          class="w-full inline-flex justify-center items-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium transition-colors duration-200 hover-scale focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          :class="darkMode ? 
            'border-gray-700 bg-gray-700 text-white hover:bg-gray-600 focus:ring-offset-gray-800' : 
            'border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-offset-white'"
        >
          <i class="fab fa-microsoft text-lg" :class="darkMode ? 'text-white' : 'text-blue-600'"></i>
        </a>
      </div>
    </div>
      
    <!-- Footer -->
    <div class="mt-6 text-center">
      <p class="text-sm" :class="darkMode ? 'text-gray-400' : 'text-gray-600'">
        Hai già un workspace? 
        <a 
          href="/login" 
          class="font-medium text-primary hover:text-primary-dark transition-colors duration-200 focus:outline-none focus:underline"
        >
          Accedi qui
        </a>
      </p>
    </div>
  </div>
</div>

<script>
  // Funzione per toggle dark mode (da includere nello scope globale o in Alpine)
  function toggleDarkMode() {
    this.darkMode = !this.darkMode;
    localStorage.setItem('darkMode', JSON.stringify(this.darkMode));
    document.documentElement.classList.toggle('dark', this.darkMode);
  }

  // Inizializzazione della dark mode
  document.addEventListener('alpine:init', () => {
    Alpine.data('darkMode', () => ({
      darkMode: false,
      init() {
        // Recupera la preferenza dal localStorage
        try {
          const saved = localStorage.getItem('darkMode');
          if (saved !== null) {
            this.darkMode = JSON.parse(saved);
          } else {
            // Controlla la preferenza del sistema
            this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          document.documentElement.classList.toggle('dark', this.darkMode);
        } catch(e) {
          console.error('Errore nel recupero delle preferenze dark mode:', e);
        }
      },
      toggleDarkMode
    }));

    // Signup form handler
    Alpine.data('signupForm', () => ({
      isLoading: false,
      workspaceName: '',
      email: '',
      password: '',
      errors: {},
      checkingWorkspace: false,
      workspaceAvailable: null,
      workspaceCheckTimeout: null,
      
      validateWorkspace() {
        const re = /^[a-zA-Z0-9-]+$/;
        this.errors = {};
        
        if (!this.workspaceName.trim()) {
          this.errors.workspaceName = 'Nome workspace obbligatorio';
          return false;
        }
        
        if (this.workspaceName.length < 3 || this.workspaceName.length > 63) {
          this.errors.workspaceName = 'Il nome deve essere tra 3 e 63 caratteri';
          return false;
        }
        
        if (!re.test(this.workspaceName)) {
          this.errors.workspaceName = 'Solo caratteri alfanumerici e trattini sono permessi';
          return false;
        }
        
        return true;
      },
      
      checkWorkspaceAvailability() {
        // Clear previous timeout
        if (this.workspaceCheckTimeout) {
          clearTimeout(this.workspaceCheckTimeout);
        }
        
        // Validate before checking
        if (!this.validateWorkspace()) {
          this.workspaceAvailable = false;
          return;
        }
        
        // Set timeout to avoid excessive API calls
        this.workspaceCheckTimeout = setTimeout(() => {
          this.checkingWorkspace = true;
          this.workspaceAvailable = null;
          
          fetch('/api/tenants/check-subdomain?subdomain=' + encodeURIComponent(this.workspaceName))
            .then(response => {
              if (!response.ok) throw new Error('Network response was not ok');
              return response.json();
            })
            .then(data => {
              if (data && typeof data.available !== 'undefined') {
                this.workspaceAvailable = data.available;
                if (!this.workspaceAvailable) {
                  this.errors.workspaceName = 'Nome non disponibile';
                }
              } else {
                this.workspaceAvailable = null;
                this.errors.workspaceName = 'Risposta dal server non valida';
              }
            })
            .catch(error => {
              console.error('Error checking workspace availability:', error);
              this.workspaceAvailable = null;
              this.errors.workspaceName = 'Errore durante la verifica della disponibilità';
            })
            .finally(() => {
              this.checkingWorkspace = false;
            });
        }, 500);
      },
      
      validateEmail() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!this.email.trim()) {
          this.errors.email = 'Email obbligatoria';
          return false;
        }
        if (!emailRegex.test(this.email)) {
          this.errors.email = 'Inserisci un indirizzo email valido';
          return false;
        }
        return true;
      },
      
      validatePassword() {
        if (!this.password) {
          this.errors.password = 'Password obbligatoria';
          return false;
        }
        if (this.password.length < 8) {
          this.errors.password = 'La password deve essere di almeno 8 caratteri';
          return false;
        }
        return true;
      },
      
      async register() {
        // Reset errors
        this.errors = {};
        
        // Validate all fields
        const isWorkspaceValid = this.validateWorkspace();
        const isEmailValid = this.validateEmail();
        const isPasswordValid = this.validatePassword();
        
        if (!isWorkspaceValid || !isEmailValid || !isPasswordValid) {
          return;
        }
        
        this.isLoading = true;
        
        // Prepare form data
        const formData = new URLSearchParams();
        formData.append('workspaceName', this.workspaceName);
        formData.append('subdomain', this.workspaceName);
        formData.append('email', this.email);
        formData.append('password', this.password);
        
        try {
          // Send JSON payload to server API
          const payload = { tenantName: this.workspaceName, email: this.email };
          const response = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const contentType = response.headers.get('content-type') || '';
          const data = contentType.includes('application/json') ? await response.json() : null;

          if (response.ok) {
            // If server provides redirect, follow it
            if (data && data.redirect) {
              window.location.href = data.redirect;
              return;
            }
            // Otherwise go to homepage
            window.location.href = '/';
          } else {
            // Handle validation errors returned as JSON
            if (data && data.errors) {
              // map errors array to a simple object for display
              const map = {};
              if (Array.isArray(data.errors)) {
                data.errors.forEach((e) => { map[e.param || 'general'] = e.msg || e.message || JSON.stringify(e); });
              }
              this.errors = map;
            } else if (data && data.error) {
              this.errors.general = data.error;
            } else {
              this.errors.general = 'Si è verificato un errore durante la registrazione';
            }
          }
        } catch (error) {
          console.error('Registration error:', error);
          this.errors.general = 'Errore di rete. Riprova più tardi.';
        } finally {
          this.isLoading = false;
        }
      }
    }));
  });
</script>