<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8" 
     :class="darkMode ? 'bg-gray-900' : 'bg-gray-100'">
  
  <!-- Toggle Dark Mode Button -->
  <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', JSON.stringify(darkMode)); document.documentElement.classList.toggle('dark', darkMode)" 
          class="absolute top-4 right-4 p-2 rounded-full bg-white dark:bg-gray-800 shadow-md hover:scale-110 transition-transform z-10"
          :title="darkMode ? 'Disattiva dark mode' : 'Attiva dark mode'">
    <i class="fas fa-moon text-gray-700 dark:text-yellow-400" x-show="!darkMode"></i>
    <i class="fas fa-sun text-yellow-400" x-show="darkMode" x-cloak></i>
  </button>

  <div :class="darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'" 
       class="max-w-md w-full space-y-8 p-8 rounded-2xl shadow-xl mx-auto transition-colors duration-300">
    
    <!-- Logo -->
    <div class="text-center">
      <a href="/">
        <img :src="darkMode ? '/media/lb-logo-w.svg' : '/media/linkbay_logo.svg'" 
             width="180" alt="Logo LinkBay-CMS" class="mx-auto">
      </a>
    </div>
      
    <!-- Titolo -->
    <div class="text-center">
      <h2 class="text-3xl font-bold" :class="darkMode ? 'text-white' : 'text-gray-900'">Crea il tuo Workspace</h2>
      <p class="mt-2 text-sm" :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Registrati per iniziare a utilizzare LinkBay-CMS</p>
    </div>
      
    <!-- Form Registrazione -->
    <div x-data="signupForm()" class="mt-8">
      <form class="space-y-6" @submit.prevent="register" novalidate>
        <template x-if="Object.keys(errors).length">
          <div class="bg-red-50 p-4 rounded">
            <template x-for="error in Object.values(errors)" :key="error">
              <p x-text="error" class="text-red-600"></p>
            </template>
          </div>
        </template>
      <!-- Workspace Name -->
      <div class="rounded-md shadow-sm -space-y-px">
        <div>
          <label for="workspaceName" class="sr-only">Nome Workspace</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-globe" :class="darkMode ? 'text-gray-400' : 'text-gray-400'"></i>
            </div>
              placeholder="Nome del tuo workspace"
            x-model="workspaceName"
            >
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <span :class="darkMode ? 'text-gray-400' : 'text-gray-500'">.linkbaycms.com</span>
            </div>
          </div>

            <!-- Keep legacy subdomain field for backend compatibility -->
            <input type="hidden" name="subdomain" :value="workspaceName">

            <!-- Validation / Availability messages -->
          <div class="mt-2 text-sm">
            <p x-show="errors.workspaceName" x-text="errors.workspaceName" class="text-red-500" x-cloak></p>
            <p x-show="checkingWorkspace" class="text-gray-500 flex items-center" x-cloak>
              <svg class="animate-spin h-4 w-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
              Verifica disponibilità...
            </p>
            <p x-show="workspaceAvailable===true" class="text-green-600">Nome disponibile</p>
            <p x-show="workspaceAvailable===false" class="text-red-500">Nome già in uso</p>
          </div>
        </div>
      </div>

      <!-- Email -->
      <div class="rounded-md shadow-sm -space-y-px">
        <div>
          <label for="email" class="sr-only">Email</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-envelope" :class="darkMode ? 'text-gray-400' : 'text-gray-400'"></i>
            </div>
            <input 
              id="email" 
              name="email" 
              type="email" 
              x-model="email"
              required 
              :class="darkMode ? 
                  'appearance-none relative block w-full pl-10 pr-3 py-3 border border-gray-600 border-t-0 bg-gray-700 placeholder-gray-400 text-white focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm' : 
                  'appearance-none relative block w-full pl-10 pr-3 py-3 border border-gray-300 border-t-0 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm'" 
              placeholder="email@esempio.com"
            >
            <p x-show="errors.email" x-text="errors.email" class="text-red-500 mt-1" x-cloak></p>
          </div>
        </div>
      </div>

      <!-- Password -->
      <div class="rounded-md shadow-sm -space-y-px">
        <div>
          <label for="password" class="sr-only">Password</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-lock" :class="darkMode ? 'text-gray-400' : 'text-gray-400'"></i>
            </div>
            <input 
              id="password" 
              name="password" 
              type="password" 
              x-model="password"
              required 
              :class="darkMode ? 
                  'appearance-none rounded-b-md relative block w-full pl-10 pr-3 py-3 border border-gray-600 border-t-0 bg-gray-700 placeholder-gray-400 text-white focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm' : 
                  'appearance-none rounded-b-md relative block w-full pl-10 pr-3 py-3 border border-gray-300 border-t-0 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm'" 
              placeholder="password"
            >
            <p x-show="errors.password" x-text="errors.password" class="text-red-500 mt-1" x-cloak></p>
          </div>
        </div>
      </div>

      <div>
        <button 
          type="submit" 
          class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors hover-scale"
          :class="darkMode ? 'focus:ring-offset-gray-800' : 'focus:ring-offset-white'"
          :disabled="isLoading"
        >
          <span class="absolute left-0 inset-y-0 flex items-center pl-3">
            <i class="fas fa-plus-circle text-white" :class="{ 'animate-pulse': isLoading }"></i>
          </span>
          <span x-show="!isLoading">Crea Workspace</span>
          <span x-show="isLoading" x-cloak>Creazione in corso...</span>
        </button>
      </div>
      </form>
    </div>
      
    <!-- Divisore -->
    <div class="relative mt-6">
      <div class="absolute inset-0 flex items-center">
        <div class="w-full border-t" :class="darkMode ? 'border-gray-700' : 'border-gray-300'"></div>
      </div>
      <div class="relative flex justify-center text-sm">
        <span class="px-2" :class="darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-500'">OPPURE</span>
      </div>
    </div>
      
    <!-- Registrazione Social -->
    <div class="mt-6">
      <p class="text-center text-sm mb-3" :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Registrati con il tuo account</p>
      <div class="grid grid-cols-3 gap-3">
        <!-- Google Workspace -->
        <a href="/auth/google/signup" 
           :class="darkMode ? 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-700 rounded-md shadow-sm bg-gray-700 text-sm font-medium text-white hover:bg-gray-600 transition-colors hover-scale' : 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors hover-scale'">
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTcuNiA5LjJsLS4xLTEuOEg5djMuNGg0LjhDMTMuNiAxMiAxMyAxMyAxMiAxMy42djIuMmgzYTguOCA4LjggMCAwIDAgMi42LTYuNnoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjxwYXRoIGQ9Ik05IDE4YzIuNCAwIDQuNS0uOCA2LTIuMmwtMy0yLjJhNS40IDUuNCAwIDAgMS04LTIuOUgxVjEzYTkgOSAwIDAgMCA4IDV6IiBmaWxsPSIjMzRBODUzIiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNIDQgMTAuN2E1LjQgNS40IDAgMCAxIDAtMy40VjVIMS45YzAtLjAyLjEtLjA1LjEtLjA1YTkgOSAwIDAgMCAwIDhsMy0yLjN6IiBmaWxsPSIjRkJCQzA1IiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNOSAzLjZjMS4zIDAgMi41LjQgMy40IDEuM0wxNSAyLjNBOSA5IDAgMCAwIDEgNWwzIDIuNGE1LjQgNS40IDAgMCAxIDUtMy43eiIgZmlsbD0iI0VBNDMzNSIgZmlsbC1ydWxlPSJub256ZXJvIi8+PHBhdGggZD0iTTAgMGgxOHYxOEgweiIvPjwvZz48L3N2Zz4=" alt="Google" class="h-5 w-5">
        </a>
              
        <!-- GitHub -->
        <a href="/auth/github/signup" 
           :class="darkMode ? 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-700 rounded-md shadow-sm bg-gray-700 text-sm font-medium text-white hover:bg-gray-600 transition-colors hover-scale' : 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors hover-scale'">
          <i class="fab fa-github text-lg" :class="darkMode ? 'text-white' : 'text-gray-800'"></i>
        </a>
              
        <!-- Microsoft -->
        <a href="/auth/microsoft/signup" 
           :class="darkMode ? 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-700 rounded-md shadow-sm bg-gray-700 text-sm font-medium text-white hover:bg-gray-600 transition-colors hover-scale' : 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors hover-scale'">
          <i class="fab fa-microsoft text-lg" :class="darkMode ? 'text-white' : 'text-blue-600'"></i>
        </a>
      </div>
    </div>
      
    <!-- Footer -->
    <div class="mt-6 text-center">
      <p class="text-sm" :class="darkMode ? 'text-gray-400' : 'text-gray-600'">
        Hai già un workspace? 
        <a href="/login" class="font-medium text-primary hover:text-primary-dark transition-colors">
          Accedi qui
        </a>
      </p>
    </div>
  </div>
</div>

<script>
  // Inizializzazione della dark mode
  document.addEventListener('alpine:init', () => {
    Alpine.data('darkMode', () => ({
      darkMode: false,
      init() {
        // Recupera la preferenza dal localStorage
        try {
          const saved = localStorage.getItem('darkMode');
          if (saved !== null) {
            this.darkMode = JSON.parse(saved);
          } else {
            // Controlla la preferenza del sistema
            this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          document.documentElement.classList.toggle('dark', this.darkMode);
        } catch(e) {}
      }
    }));
  });

  // Signup form handler
  function signupForm(){
    return {
      isLoading: false,
      workspaceName: '',
      email: '',
      password: '',
      errors: {},
      checkingWorkspace: false,
      workspaceAvailable: null,
      validateWorkspace() {
        const re = /^[a-zA-Z0-9-]+$/;
        if (!this.workspaceName) { this.errors.workspaceName = 'Nome workspace obbligatorio'; return false; }
        if (this.workspaceName.length < 3 || this.workspaceName.length > 63) { this.errors.workspaceName = 'Il nome deve essere tra 3 e 63 caratteri'; return false; }
        if (!re.test(this.workspaceName)) { this.errors.workspaceName = 'Solo caratteri alfanumerici e trattini sono permessi'; return false; }
        delete this.errors.workspaceName; return true;
      },
      checkWorkspaceAvailability() {
        if (!this.validateWorkspace()) { this.workspaceAvailable = null; return; }
        this.checkingWorkspace = true; this.workspaceAvailable = null; delete this.errors.workspaceName;
        fetch('/api/tenants/check-subdomain?subdomain=' + encodeURIComponent(this.workspaceName))
          .then(r => r.json())
          .then(j => {
            if (j && typeof j.available !== 'undefined') {
              this.workspaceAvailable = !!j.available;
              if (!this.workspaceAvailable) this.errors.workspaceName = 'Nome non disponibile';
            } else {
              this.workspaceAvailable = null;
            }
          })
          .catch(() => { this.workspaceAvailable = null; this.errors.workspaceName = 'Errore verifica disponibilità'; })
          .finally(() => { this.checkingWorkspace = false; });
      },
      async register(){
        this.isLoading = true; this.errors = {};
        // client-side validation
        if (!this.validateWorkspace()) { this.isLoading = false; return; }
        if (!this.email) { this.errors.email = 'Email obbligatoria'; this.isLoading = false; return; }
        if (!this.password) { this.errors.password = 'Password obbligatoria'; this.isLoading = false; return; }

        // Prepare form-encoded body (backend expects urlencoded)
        const body = new URLSearchParams();
        body.append('workspaceName', this.workspaceName);
        body.append('subdomain', this.workspaceName); // legacy
        body.append('email', this.email);
        body.append('password', this.password);

        try {
          const res = await fetch('/signup', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
          const contentType = res.headers.get('content-type') || '';
          if (res.ok) {
            // If JSON returned, may include redirect
            if (contentType.includes('application/json')) {
              const j = await res.json();
              if (j && j.redirect) { window.location.href = j.redirect; return; }
              if (j && j.tenant) { window.location.href = '/'; return; }
            }
            // Otherwise follow Location header or reload
            const loc = res.headers.get('location');
            if (loc) { window.location.href = loc; return; }
            window.location.reload();
          } else {
            // parse JSON structured errors if present
            if (contentType.includes('application/json')) {
              const j = await res.json();
              if (j && j.errors) { this.errors = j.errors; }
              else if (j && j.error) { this.errors._ = j.error; }
              else { this.errors._ = 'Errore durante la registrazione'; }
            } else {
              // try to read text
              const txt = await res.text();
              this.errors._ = txt || 'Errore durante la registrazione';
            }
          }
        } catch (e) {
          this.errors._ = 'Errore di rete. Riprova.';
        } finally {
          this.isLoading = false;
        }
      }
    };
  }
</script>