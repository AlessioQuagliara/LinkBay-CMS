<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8" 
     :class="darkMode ? 'bg-gray-900' : 'bg-gray-100'">
  
  <!-- Toggle Dark Mode Button -->
  <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', JSON.stringify(darkMode)); document.documentElement.classList.toggle('dark', darkMode)" 
          class="absolute top-4 right-4 p-2 rounded-full bg-white dark:bg-gray-800 shadow-md hover:scale-110 transition-transform z-10"
          :title="darkMode ? 'Disattiva dark mode' : 'Attiva dark mode'">
    <i class="fas fa-moon text-gray-700 dark:text-yellow-400" x-show="!darkMode"></i>
    <i class="fas fa-sun text-yellow-400" x-show="darkMode" x-cloak></i>
  </button>

  <div :class="darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'" 
       class="max-w-md w-full space-y-8 p-8 rounded-2xl shadow-xl mx-auto transition-colors duration-300">
    
    <!-- Logo -->
    <div class="text-center">
      <a href="/">
        <img :src="darkMode ? '/media/lb-logo-w.svg' : '/media/linkbay_logo.svg'" 
             width="180" alt="Logo LinkBay-CMS" class="mx-auto">
      </a>
    </div>
      
    <!-- Titolo -->
    <div class="text-center">
      <h2 class="text-3xl font-bold" :class="darkMode ? 'text-white' : 'text-gray-900'">Accedi al tuo Workspace</h2>
      <p class="mt-2 text-sm" :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Inserisci la tua email aziendale per accedere</p>
    </div>

<script>
  // Handler per login via provider dalla landing: chiama API tenant-aware e reindirizza
  document.addEventListener('DOMContentLoaded', () => {
    const emailInput = document.querySelector('input[name="email"]');
    const getEmail = () => (emailInput ? emailInput.value.trim() : '');

    const loader = document.createElement('div');
    loader.id = 'auth-loader';
    loader.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:9999;';
    loader.innerHTML = '<div class="bg-white p-6 rounded shadow">Accesso in corso...<div class="loader" style="margin-top:8px"></div></div>';
    document.body.appendChild(loader);

    function showLoader(){ loader.style.display = 'flex'; }
    function hideLoader(){ loader.style.display = 'none'; }

    async function startProvider(provider){
      try {
        showLoader();
        const res = await fetch('/api/auth/provider-redirect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider, email: getEmail() })
        });
        const json = await res.json();
        if (!res.ok || !json.redirect){
          const msg = (json && json.error) ? json.error : 'Impossibile risolvere il tenant per il login';
          alert(msg);
          hideLoader();
          return;
        }
        // naviga al redirect tenant-scoped
        window.location.href = json.redirect;
      } catch (err) {
        console.error(err);
        alert('Errore durante il reindirizzamento al provider');
        hideLoader();
      }
    }

    document.getElementById('google-login-btn')?.addEventListener('click', ev => { ev.preventDefault(); startProvider('google'); });
    document.getElementById('github-login-btn')?.addEventListener('click', ev => { ev.preventDefault(); startProvider('github'); });
    document.getElementById('microsoft-login-btn')?.addEventListener('click', ev => { ev.preventDefault(); startProvider('microsoft'); });

    // handle token in query string after provider redirect (fallback when server includes token in URL)
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token') || params.get('t') || params.get('access_token');
    if (token){
      try {
        // store token in localStorage as fallback (cannot set httpOnly cookie from JS)
        localStorage.setItem('access_token', token);
        // remove token from URL
        params.delete('token'); params.delete('t'); params.delete('access_token');
        const newUrl = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '');
        window.history.replaceState({}, document.title, newUrl);
        // redirect to dashboard on same host
        window.location.href = `${window.location.protocol}//${window.location.host}/dashboard`;
      } catch(e){ console.error('callback token handling error', e); }
    }
  });
</script>
      
  <!-- Form Login -->
  <form class="mt-8 space-y-6" method="POST" action="/login-redirect" x-data="{ isLoading: false }" @submit.prevent="isLoading = true; $el.submit()">
      <div class="rounded-md shadow-sm -space-y-px">
        <div>
          <label for="email" class="sr-only">Email aziendale</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-envelope" :class="darkMode ? 'text-gray-400' : 'text-gray-400'"></i>
            </div>
            <input 
              id="email" 
              name="email" 
              type="email" 
              required 
              :class="darkMode ? 
                  'appearance-none rounded-t-md rounded-b-md relative block w-full pl-10 pr-3 py-3 border border-gray-600 bg-gray-700 placeholder-gray-400 text-white focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm' : 
                  'appearance-none rounded-t-md rounded-b-md relative block w-full pl-10 pr-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm'" 
              placeholder="es. nome@azienda.com"
            >
          </div>
        </div>
      </div>

      <div>
        <button 
          type="submit" 
          class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors hover-scale"
          :class="darkMode ? 'focus:ring-offset-gray-800' : 'focus:ring-offset-white'"
          :disabled="isLoading"
        >
          <span class="absolute left-0 inset-y-0 flex items-center pl-3">
            <i class="fas fa-arrow-right text-white" :class="{ 'animate-pulse': isLoading }"></i>
          </span>
          <span x-show="!isLoading">Continua</span>
          <span x-show="isLoading" x-cloak>Caricamento...</span>
        </button>
      </div>
    </form>
      
    <!-- Divisore -->
    <div class="relative mt-6">
      <div class="absolute inset-0 flex items-center">
        <div class="w-full border-t" :class="darkMode ? 'border-gray-700' : 'border-gray-300'"></div>
      </div>
      <div class="relative flex justify-center text-sm">
        <span class="px-2" :class="darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-500'">OPPURE</span>
      </div>
    </div>
      
    <!-- Login Social -->
    <div class="mt-6">
      <p class="text-center text-sm mb-3" :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Accedi con il tuo account</p>
      <div class="grid grid-cols-3 gap-3">
        <!-- Google Workspace -->
        <button type="button" id="google-login-btn"
           :class="darkMode ? 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-700 rounded-md shadow-sm bg-gray-700 text-sm font-medium text-white hover:bg-gray-600 transition-colors hover-scale' : 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors hover-scale'">
          <a href="/auth/google" class="sr-only">Fallback Google login</a>
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTcuNiA5LjJsLS4xLTEuOEg5djMuNGg0LjhDMTMuNiAxMiAxMyAxMyAxMiAxMy42djIuMmgzYTguOCA4LjggMCAwIDAgMi42LTYuNnoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjxwYXRoIGQ9Ik05IDE4YzIuNCAwIDQuNS0uOCA2LTIuMmwtMy0yLjJhNS40IDUuNCAwIDAgMS04LTIuOUgxVjEzYTkgOSAwIDAgMCA4IDV6IiBmaWxsPSIjMzRBODUzIiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNIDQgMTAuN2E1LjQgNS40IDAgMCAxIDAtMy40VjVIMS45YzAtLjAyLjEtLjA1LjEtLjA1YTkgOSAwIDAgMCAwIDhsMy0yLjN6IiBmaWxsPSIjRkJCQzA1IiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNOSAzLjZjMS4zIDAgMi41LjQgMy40IDEuM0wxNSAyLjNBOSA5IDAgMCAwIDEgNWwzIDIuNGE1LjQgNS40IDAgMCAxIDUtMy43eiIgZmlsbD0iI0VBNDMzNSIgZmlsbC1ydWxlPSJub256ZXJvIi8+PHBhdGggZD0iTTAgMGgxOHYxOEgweiIvPjwvZz48L3N2Zz4=" alt="Google" class="h-5 w-5">
        </button>
              
        <!-- GitHub -->
        <button type="button" id="github-login-btn"
           :class="darkMode ? 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-700 rounded-md shadow-sm bg-gray-700 text-sm font-medium text-white hover:bg-gray-600 transition-colors hover-scale' : 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors hover-scale'">
          <i class="fab fa-github text-lg" :class="darkMode ? 'text-white' : 'text-gray-800'"></i>
        </button>
              
        <!-- Microsoft -->
        <button type="button" id="microsoft-login-btn"
           :class="darkMode ? 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-700 rounded-md shadow-sm bg-gray-700 text-sm font-medium text-white hover:bg-gray-600 transition-colors hover-scale' : 
               'w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors hover-scale'">
          <i class="fab fa-microsoft text-lg" :class="darkMode ? 'text-white' : 'text-blue-600'"></i>
        </button>
      </div>
    </div>
      
    <!-- Footer -->
    <div class="mt-6 text-center">
      <p class="text-sm" :class="darkMode ? 'text-gray-400' : 'text-gray-600'">
        Non hai un workspace? 
        <a href="/signup" class="font-medium text-primary hover:text-primary-dark transition-colors">
          Creane uno ora
        </a>
      </p>
    </div>
  </div>
</div>

<script>
  // Inizializzazione della dark mode
  document.addEventListener('alpine:init', () => {
    Alpine.data('darkMode', () => ({
      darkMode: false,
      init() {
        // Recupera la preferenza dal localStorage
        try {
          const saved = localStorage.getItem('darkMode');
          if (saved !== null) {
            this.darkMode = JSON.parse(saved);
          } else {
            // Controlla la preferenza del sistema
            this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          document.documentElement.classList.toggle('dark', this.darkMode);
        } catch(e) {}
      }
    }));
  });
</script>