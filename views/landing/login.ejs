<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 transition-colors duration-300" 
     :class="darkMode ? 'bg-gray-900' : 'bg-gray-100'">
  
  <!-- Pulsante Toggle Dark Mode -->
  <button 
    @click="toggleDarkMode"
    class="absolute top-4 right-4 p-2 rounded-full bg-white dark:bg-gray-800 shadow-md hover:scale-110 transition-transform z-10 focus:outline-none focus:ring-2 focus:ring-primary"
    :title="darkMode ? 'Disattiva modalità scura' : 'Attiva modalità scura'"
    aria-label="Cambia modalità chiara/scura"
  >
    <i class="fas fa-moon text-gray-700 dark:text-yellow-400" x-show="!darkMode"></i>
    <i class="fas fa-sun text-yellow-400" x-show="darkMode" x-cloak></i>
  </button>

  <div 
    :class="darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'" 
    class="max-w-md w-full space-y-8 p-8 rounded-2xl shadow-xl mx-auto transition-colors duration-300"
  >
    <!-- Logo -->
    <div class="text-center">
      <a href="/" aria-label="Torna alla homepage">
        <img 
          :src="darkMode ? '/media/lb-logo-w.svg' : '/media/linkbay_logo.svg'" 
          width="180" 
          alt="Logo LinkBay-CMS" 
          class="mx-auto transition-opacity duration-300 hover:opacity-90"
        >
      </a>
    </div>
      
    <!-- Titolo -->
    <div class="text-center">
      <h1 class="text-3xl font-bold" :class="darkMode ? 'text-white' : 'text-gray-900'">
        Accedi al tuo Workspace
      </h1>
      <p class="mt-2 text-sm" :class="darkMode ? 'text-gray-300' : 'text-gray-600'">
        Inserisci la tua email aziendale per accedere
      </p>
    </div>
      
    <!-- Form Login -->
    <form 
      class="mt-8 space-y-6" 
      method="POST" 
      action="/auth/preflight" 
      x-data="{ isLoading: false }" 
      @submit.prevent="submitForm"
    >
      <!-- default provider for continue flow -->
      <input type="hidden" name="provider" value="google">
      <div class="rounded-md shadow-sm -space-y-px">
        <div>
          <label for="email" class="sr-only">Email aziendale</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-envelope" :class="darkMode ? 'text-gray-400' : 'text-gray-400'"></i>
            </div>
            <input 
              id="email" 
              name="email" 
              type="email" 
              required 
              autocomplete="email"
              :class="[
                'appearance-none rounded-md relative block w-full pl-10 pr-3 py-3 border focus:outline-none focus:ring-2 focus:ring-primary focus:z-10 sm:text-sm',
                darkMode ? 
                  'border-gray-600 bg-gray-700 placeholder-gray-400 text-white focus:border-primary' : 
                  'border-gray-300 placeholder-gray-500 text-gray-900 focus:border-primary'
              ]" 
              placeholder="es. nome@azienda.com"
              :disabled="isLoading"
            >
          </div>
        </div>
      </div>

      <div>
        <button 
          type="submit" 
          class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all duration-300 hover-scale"
          :class="[
            darkMode ? 'focus:ring-offset-gray-800' : 'focus:ring-offset-white',
            isLoading ? 'opacity-75 cursor-not-allowed' : ''
          ]"
          :disabled="isLoading"
          aria-label="Continua con l'accesso"
        >
          <span class="absolute left-0 inset-y-0 flex items-center pl-3">
            <i 
              class="fas fa-arrow-right text-white transition-all" 
              :class="{ 'animate-spin': isLoading }"
              x-show="isLoading"
            ></i>
          </span>
          <span x-show="!isLoading">Continua</span>
          <span x-show="isLoading" x-cloak>Accesso in corso...</span>
        </button>
      </div>
    </form>
      
    <!-- Divisore -->
    <div class="relative mt-6">
      <div class="absolute inset-0 flex items-center">
        <div class="w-full border-t" :class="darkMode ? 'border-gray-700' : 'border-gray-300'"></div>
      </div>
      <div class="relative flex justify-center text-sm">
        <span class="px-2" :class="darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-500'">
          OPPURE
        </span>
      </div>
    </div>
      
    <!-- Login Social -->
    <div class="mt-6">
      <p class="text-center text-sm mb-3" :class="darkMode ? 'text-gray-300' : 'text-gray-600'">
        Accedi con il tuo account
      </p>
      <div class="grid grid-cols-3 gap-3 social-buttons">
        <!-- Google Workspace -->
        <button 
          type="button" 
          id="google-login-btn"
          :class="[
            'w-full inline-flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium transition-colors hover-scale focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary',
            darkMode ? 
              'border-gray-700 bg-gray-700 text-white hover:bg-gray-600 focus:ring-offset-gray-800' : 
              'border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-offset-white'
          ]"
          aria-label="Accedi con Google"
        >
          <img 
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTcuNiA5LjJsLS4xLTEuOEg5djMuNGg0LjhDMTMuNiAxMiAxMyAxMyAxMiAxMy42djIuMmgzYTguOCA4LjggMCAwIDAgMi42LTYuNnoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjxwYXRoIGQ9Ik05IDE4YzIuNCAwIDQuNS0uOCA2LTIuMmwtMy0yLjJhNS40IDUuNCAwIDAgMS04LTIuOUgxVjEzYTkgOSAwIDAgMCA4IDV6IiBmaWxsPSIjMzRBODUzIiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNIDQgMTAuN2E1LjQgNS40IDAgMCAxIDAtMy40VjVIMS45YzAtLjAyLjEtLjA1LjEtLjA1YTkgOSAwIDAgMCAwIDhsMy0yLjN6IiBmaWxsPSIjRkJCQzA1IiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNOSAzLjZjMS4zIDAgMi41LjQgMy40IDEuM0wxNSAyLjNBOSA5IDAgMCAwIDEgNWwzIDIuNGE1LjQgNS40IDAgMCAxIDUtMy43eiIgZmlsbD0iI0VBNDMzNSIgZmlsbC1ydWxlPSJub256ZXJvIi8+PHBhdGggZD0iTTAgMGgxOHYxOEgweiIvPjwvZz48L3N2Zz4=" 
            alt="Google" 
            class="h-5 w-5"
          >
        </button>
              
        <!-- GitHub -->
        <button 
          type="button" 
          id="github-login-btn"
          :class="[
            'w-full inline-flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium transition-colors hover-scale focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary',
            darkMode ? 
              'border-gray-700 bg-gray-700 text-white hover:bg-gray-600 focus:ring-offset-gray-800' : 
              'border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-offset-white'
          ]"
          aria-label="Accedi con GitHub"
        >
          <i class="fab fa-github text-lg" :class="darkMode ? 'text-white' : 'text-gray-800'"></i>
        </button>
              
        <!-- Microsoft -->
        <button 
          type="button" 
          id="microsoft-login-btn"
          :class="[
            'w-full inline-flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium transition-colors hover-scale focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary',
            darkMode ? 
              'border-gray-700 bg-gray-700 text-white hover:bg-gray-600 focus:ring-offset-gray-800' : 
              'border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-offset-white'
          ]"
          aria-label="Accedi con Microsoft"
        >
          <i class="fab fa-microsoft text-lg" :class="darkMode ? 'text-white' : 'text-blue-600'"></i>
        </button>
      </div>
    </div>
      
    <!-- Footer -->
    <div class="mt-6 text-center">
      <p class="text-sm" :class="darkMode ? 'text-gray-400' : 'text-gray-600'">
        Non hai un workspace? 
        <a 
          href="/signup" 
          class="font-medium text-primary hover:text-primary-dark transition-colors duration-300 focus:outline-none focus:underline"
          aria-label="Crea un nuovo workspace"
        >
          Creane uno ora
        </a>
      </p>
    </div>
  </div>
</div>

<!-- Loader per autenticazione -->
<div 
  id="auth-loader" 
  class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 hidden"
  aria-hidden="true"
  role="dialog"
  aria-label="Caricamento in corso"
>
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-xs w-full mx-4">
    <div class="text-center">
      <div class="loader mx-auto mb-4"></div>
      <p class="text-gray-800 dark:text-white" id="auth-loader-text">Accesso in corso...</p>
    </div>
  </div>
</div>

<script>
  // Funzionalità principale dell'applicazione
  function loginApp() {
    return {
      darkMode: false,
      
      init() {
        // Inizializza la dark mode
        this.initDarkMode();
        
        // Gestione del token nell'URL (se presente)
        this.handleUrlToken();
      },
      
      initDarkMode() {
        try {
          const saved = localStorage.getItem('darkMode');
          if (saved !== null) {
            this.darkMode = JSON.parse(saved);
          } else {
            // Controlla la preferenza del sistema
            this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          this.applyDarkMode();
        } catch(e) {
          console.error('Errore nel recupero delle preferenze dark mode:', e);
        }
      },
      
      toggleDarkMode() {
        this.darkMode = !this.darkMode;
        this.applyDarkMode();
        
        // Salva la preferenza
        try {
          localStorage.setItem('darkMode', JSON.stringify(this.darkMode));
        } catch(e) {
          console.error('Errore nel salvataggio delle preferenze dark mode:', e);
        }
      },
      
      applyDarkMode() {
        document.documentElement.classList.toggle('dark', this.darkMode);
      },
      
      submitForm() {
        this.isLoading = true;
        // Invia il form dopo un breve ritardo per mostrare l'animazione
        setTimeout(() => {
          this.$el.submit();
        }, 300);
      },
      
      handleUrlToken() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token') || params.get('t') || params.get('access_token');
        
        if (token) {
          try {
            // Memorizza il token nel localStorage
            localStorage.setItem('access_token', token);
            
            // Rimuove il token dall'URL
            params.delete('token'); 
            params.delete('t'); 
            params.delete('access_token');
            
            const newUrl = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '');
            window.history.replaceState({}, document.title, newUrl);
            
            // Reindirizza alla dashboard
            window.location.href = `${window.location.protocol}//${window.location.host}/dashboard`;
          } catch(e) {
            console.error('Errore nella gestione del token:', e);
          }
        }
      }
    };
  }

  // Gestione del login con provider
  document.addEventListener('DOMContentLoaded', function() {
    const emailInput = document.querySelector('input[name="email"]');
    const getEmail = () => emailInput ? emailInput.value.trim() : '';
    
    const authLoader = document.getElementById('auth-loader');
    const authLoaderText = document.getElementById('auth-loader-text');
    
    function showLoader(message = 'Accesso in corso...') {
      authLoaderText.textContent = message;
      authLoader.classList.remove('hidden');
    }
    
    function hideLoader() {
      authLoader.classList.add('hidden');
    }
    
    async function startProvider(provider) {
      try {
        showLoader(`Reindirizzamento a ${provider}...`);

        // The server expects a POST to /auth/preflight with { tenantName, provider }
        // We attempt to derive tenantName from the email local-part as a best-effort
        // assumption. If you use different tenant resolution, adapt this logic.
        const email = getEmail();
        let tenantName = '';
        if (email && email.includes('@')) {
          tenantName = email.split('@')[0]; // assumption: tenantName == local-part
        }

        // Create and submit a traditional form so the browser follows the server redirect
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/auth/preflight';
        form.style.display = 'none';

        const pInput = document.createElement('input');
        pInput.type = 'hidden';
        pInput.name = 'provider';
        pInput.value = provider;
        form.appendChild(pInput);

        const tInput = document.createElement('input');
        tInput.type = 'hidden';
        tInput.name = 'tenantName';
        tInput.value = tenantName;
        form.appendChild(tInput);

        document.body.appendChild(form);
        form.submit();
      } catch (err) {
        console.error(err);
        hideLoader();
        alert(err.message || 'Errore durante il reindirizzamento al provider');
      }
    }
    
    // Aggiungi event listener ai pulsanti
    document.getElementById('google-login-btn')?.addEventListener('click', function(ev) {
      ev.preventDefault();
      startProvider('google');
    });
    
    document.getElementById('github-login-btn')?.addEventListener('click', function(ev) {
      ev.preventDefault();
      startProvider('github');
    });
    
    document.getElementById('microsoft-login-btn')?.addEventListener('click', function(ev) {
      ev.preventDefault();
      startProvider('microsoft');
    });
  });
</script>