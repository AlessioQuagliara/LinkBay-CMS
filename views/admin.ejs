<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style> .card{border:1px solid #ddd;padding:1rem;margin:1rem;border-radius:6px} .grid{display:flex;flex-wrap:wrap} .card .actions{margin-top:8px}</style>
  </head>
  <body>
  <h1><%= t('dashboard.title') %></h1>
    <div id="metrics" class="grid"></div>
    <h2>Tenants</h2>
    <div id="tenants"></div>

    <script>
      async function fetchJson(path){ const r = await fetch(path); return r.json(); }
      async function load(){
        const stats = await fetchJson('/admin/stats');
        const tenants = await fetchJson('/admin/tenants');
        document.getElementById('metrics').innerHTML = `
          <div class="card">Tenants: <strong>${stats.totals.tenants}</strong></div>
          <div class="card">Users: <strong>${stats.totals.users}</strong></div>
          <div class="card">Orders today: <strong>${stats.totals.orders_today}</strong></div>
        `;
        const tdiv = document.getElementById('tenants');
        tdiv.innerHTML = '';
        tenants.tenants.forEach(t=>{
          const el = document.createElement('div'); el.className='card';
          el.innerHTML = `<strong>${t.name}</strong> (${t.subdomain}) - status: <em>${t.status}</em>`;
          const btn = document.createElement('button'); btn.textContent = t.status==='active'?'Suspend':'Activate';
          btn.onclick = async ()=>{ const res = await fetch(`/admin/tenants/${t.id}/toggle`, { method:'POST' }); const j = await res.json(); if (j.success) load(); };
          const actions = document.createElement('div'); actions.className='actions'; actions.appendChild(btn); el.appendChild(actions);
          tdiv.appendChild(el);
        });
      }
      load();
    </script>
      <!-- Intro.js for interactive tour -->
      <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css" />
      <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
      <script>
        async function checkAndStartTour(){
          try{
            const st = await fetch('/api/user/onboarding-status');
            const json = await st.json();
            if(!json.onboarding_completed){
              // define steps
              const steps = [
                { intro: "Welcome to the Admin dashboard! This tour will guide you through common tasks." },
                { element: document.querySelector('#metrics'), intro: 'This area shows quick metrics for your store.' },
                { intro: 'Create a new page from the Pages section to start building your site.' },
                { intro: 'Add products from the Products section to start selling.' },
                { intro: 'Visit Settings to configure branding, payment and shipping.' }
              ];
              const tour = introJs();
              tour.setOptions({ steps, showProgress: true, exitOnOverlayClick: false });
              tour.oncomplete(async ()=>{ await fetch('/api/user/onboarding-status', { method: 'POST' }); });
              tour.onexit(async ()=>{ /* optional: mark partial completion? */ });
              tour.start();
            }
          }catch(e){ console.warn('Onboarding check failed', e); }
        }
        // try to run after load
        window.addEventListener('load', ()=>{ checkAndStartTour(); });
      </script>
  </body>
</html>
