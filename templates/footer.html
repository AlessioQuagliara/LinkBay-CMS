<!-- MODALE BOOTSTRAP 5.3.3 PER RENDERIZZARE IL CARRELLO -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="cartModalLabel">Shopping Cart</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-dark">
                <tr>
                  <th scope="col">Image</th>
                  <th scope="col">Product</th>
                  <th scope="col">Price</th>
                  <th scope="col">Quantity</th>
                  <th scope="col">Total</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody id="cartContainer">
                <!-- Contenuto del carrello viene generato dinamicamente -->
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <h5>Total: <span id="cartTotal" class="text-success">€0.00</span></h5>
            <button class="btn btn-danger" id="clearCart">Clear Cart</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Shopping</button>
          <button type="button" class="btn btn-primary" id="checkoutButton">Proceed to Checkout</button>
        </div>
      </div>
    </div>
  </div>


<script>
    // DROPDOWN NAVBAR --------------------------------------------------------------------------------------------------- 
    document.addEventListener('DOMContentLoaded', function () {
        const collectionsMenu = document.getElementById('collectionsMenu');
    
        // Ottieni il nome del negozio dal subdomain o altra fonte
        const shopName = "{{ shop_subdomain }}";
    
        // Effettua una richiesta AJAX per ottenere le collezioni
        fetch(`/api/collections?shop_name=${shopName}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.collections.length > 0) {
                    // Popola il dropdown con le collezioni
                    data.collections.forEach(collection => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a class="dropdown-item" href="/collections/${collection.slug}">${collection.name}</a>`;
                        collectionsMenu.appendChild(listItem);
                    });
                } else {
                    // Nessuna collezione trovata
                    const emptyItem = document.createElement('li');
                    emptyItem.innerHTML = `<span class="dropdown-item text-muted">No collections available</span>`;
                    collectionsMenu.appendChild(emptyItem);
                }
            })
            .catch(error => {
                console.error('Error fetching collections:', error);
            });
    });
    </script>

    <script>
        // AGGIUNGI AL CARRELLO -----------------------------------------------------------------------------------------------
        function addToCart(product) {
            console.log("Adding product:", product);

            const cart = getCart();
            const existingProduct = cart.find(item => item.id === product.id);

            if (existingProduct) {
                existingProduct.quantity += 1;
            } else {
                cart.push(product);
            }

            saveCart(cart);
            console.log("Updated cart:", cart);

            Swal.fire({
                title: 'Success!',
                text: 'Product added to cart!',
                icon: 'success',
                confirmButtonText: 'OK'
            });
        }
    </script>

    <script>
        // SCRIPT DI AGGIUNTA AL CARRELLO -------------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', function () {
            const addToCartButtons = document.querySelectorAll('.add-to-cart');
        
            addToCartButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const productId = button.getAttribute('data-product-id');
                    const productName = button.getAttribute('data-product-name');
                    const productPrice = button.getAttribute('data-product-price');
                    const productImage = button.getAttribute('data-product-image');
        
                    const product = {
                        id: productId,
                        name: productName,
                        price: parseFloat(productPrice), // Assicurati che il prezzo sia un numero
                        image: productImage,
                        quantity: 1
                    };
        
                    addToCart(product);
        
                    // Recupera il carrello aggiornato e loggalo
                    const cart = getCart();
                    console.log("Product added to cart:", product);
                    console.log("Updated cart:", cart);
        
                    Swal.fire({
                        title: 'Success!',
                        text: 'Product added to cart!',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                });
            });
        });
        </script>

    <script>
        // RECUPERA IL CARRELLO DALLA SESSIONE --------------------------------------------------------------------------------
        function getCart(){
            const cart = localStorage.getItem('cart');
            return cart ? JSON.parse(cart) : [];
        }
    </script>

    <script>
        // FUNZIONE PER SALVARE IL CARRELLO ------------------------------------------------------------------------------
        function saveCart(cart){
            localStorage.setItem('cart', JSON.stringify(cart));
        }
    </script>

    <script>
        // FUNZIONE PER RIMUOVERE UN PRODOTTO DAL CARRELLO ----------------------------------------------------------------
        function removeFromCart(productId){
            const cart = getCart();
            const updatedCart = cart.filter(item => item.id !== productId);
            saveCart(updatedCart);
            Swal.fire({
                title: 'Removed!',
                text: 'Product removed from cart!',
                icon: 'info',
                confirmButtonText: 'OK'
            });
        }
    </script>

    <script>
        // FUNZIONE PER AGGIORNARE LA QUANTITÀ DI UN PRODOTTO NEL CARRELLO ---------------------------------------------------
        function updateQuantity(productId, quantity){
            const cart = getCart();
            const product = cart.find(item => item.id === productId);

            if (product){
                product.quantity = quantity;
                saveCart(cart);
                Swal.fire({
                    title: 'Updated!',
                    text: 'Cart updated!',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            }
        }
    </script>

    <script>
        // FUNZIONE PER VISUALIZZARE IL CARRELLO -------------------------------------------------------------------------------
        function renderCart() {
            const cart = getCart();
            console.log("Rendering cart:", cart);

            const cartContainer = document.getElementById('cartContainer');
            const cartTotal = document.getElementById('cartTotal');

            if (cart.length > 0) {
                cartContainer.innerHTML = ''; // Svuota il contenitore

                cart.forEach(product => {
                    // Validazione dei dati del prodotto
                    const price = parseFloat(product.price) || 0; // Converte in numero o imposta 0
                    const quantity = parseInt(product.quantity) || 1; // Default a 1 se mancante o invalido

                    console.log("Rendering product:", product);

                    const productRow = document.createElement('tr');
                    productRow.innerHTML = `
                        <td>
                            <img src="${product.image}" alt="${product.name}" class="img-fluid" style="max-width: 50px;">
                        </td>
                        <td>${product.name}</td>
                        <td>€${price.toFixed(2)}</td>
                        <td>
                            <input type="number" class="form-control" value="${quantity}" min="1" onchange="updateQuantity('${product.id}', this.value)">
                        </td>
                        <td>€${(price * quantity).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeFromCart('${product.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    cartContainer.appendChild(productRow);
                });

                const total = cart.reduce((acc, item) => acc + ((parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1)), 0);
                cartTotal.textContent = `€${total.toFixed(2)}`;
            } else {
                console.log("Cart is empty.");
                cartContainer.innerHTML = '<tr><td colspan="6">Cart is empty</td></tr>';
                cartTotal.textContent = '€0.00';
            }
        }
    </script>

    <script>
        // PULIRE IL CARRELLO 
        function clearCart(){
            localStorage.removeItem('cart');
            renderCart();
        }
    </script>

    <script>
        // LISTENER MODALE
        document.addEventListener('DOMContentLoaded', () => {
            const cartModal = document.getElementById('cartModal');
            if (cartModal) {
                cartModal.addEventListener('shown.bs.modal', renderCart);
            }
        });
    </script>