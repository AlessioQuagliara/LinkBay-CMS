{% extends "/admin/cms/interface/render.html" %}
{% block content %}

<div class="container py-4" data-aos="fade-up">

  <div class="card shadow-sm bg-white border-0">
    <div class="card-header bg-dark text-white">
      <h6 class="mb-0">Elenco Varianti del Prodotto</h6>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Nome</th>
            <th>SKU</th>
            <th>EAN</th>
            <th>Prezzo (+/-)</th>
            <th>Quantità</th>
            <th>Default</th>
            <th>Elimina
            </th>
          </tr>
        </thead>
        <tbody>
          {% for v in variants %}
          <tr>
            <td>{{ v.name }}</td>
            <td>{{ v.sku }}</td>
            <td>{{ v.ean_code or '-' }}</td>
            <td>{{ v.price_modifier }} €</td>
            <td>{{ v.stock_quantity }}</td>
            <td>
              {% if v.is_default %}
                <i class="fa-solid fa-toggle-on"></i>
              {% else %}
              <a onclick="setDefaultVariant({{ v.id }})" style="cursor: pointer;">
                <i class="fa-solid fa-toggle-off"></i>
              </a>
              {% endif %}
            </td>
            <td>
              <button class="btn btn-sm btn-danger delete-variant-btn" data-id="{{ v.id }}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">Nessuna variante presente.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function setDefaultVariant(variantId) {
      Swal.fire({
        title: 'Imposta come predefinita?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sì, imposta',
        cancelButtonText: 'Annulla',
        showLoaderOnConfirm: true,
        preConfirm: () => {
          return fetch(`/api/set_default_variant/${variantId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Errore durante la richiesta');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              Swal.fire({
                title: 'Impostata con successo!',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
              }).then(() => {
                window.location.reload();
              });
            } else {
              Swal.fire('Errore', data.message || 'Errore durante l\'impostazione.', 'error');
            }
          })
          .catch(error => {
            Swal.fire('Errore', error.message, 'error');
          });
        },
        allowOutsideClick: () => !Swal.isLoading()
      });
    }
  </script>

    <form method="POST" class="card shadow-sm p-4 mb-5 bg-white border-0">
    <h5 class="fw-semibold mb-3">Aggiungi Nuova Variante</h5>
    <div class="row g-3">
      <div class="col-md-4">
        <label for="name" class="form-label">Nome Variante *</label>
        <input type="text" class="form-control" name="name" id="name" required>
      </div>
      <div class="col-md-4">
        <label for="sku" class="form-label">SKU *</label>
        <input type="text" class="form-control" name="sku" id="sku" required>
      </div>
      <div class="col-md-4">
        <label for="ean_code" class="form-label">EAN Code</label>
        <input type="text" class="form-control" name="ean_code" id="ean_code">
      </div>
      <div class="col-md-4">
        <label for="price_modifier" class="form-label">Prezzo Aggiuntivo (€)</label>
        <input type="number" step="0.01" class="form-control" name="price_modifier" id="price_modifier">
      </div>
      <div class="col-md-4">
        <label for="stock_quantity" class="form-label">Quantità in Magazzino</label>
        <input type="number" class="form-control" name="stock_quantity" id="stock_quantity">
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="is_default" id="is_default" value="true">
          <label class="form-check-label" for="is_default">Imposta come Default</label>
        </div>
      </div>
      <div class="col-md-4 d-flex align-items-end justify-content-end">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i> Aggiungi Variante
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  document.querySelectorAll('.delete-variant-btn').forEach(button => {
    button.addEventListener('click', async (e) => {
      const id = e.currentTarget.getAttribute('data-id');
      Swal.fire({
        title: 'Sicuro di voler cancellare questa variante?',
        text: 'Questa azione è irreversibile!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sì, cancella',
        cancelButtonText: 'Annulla'
      }).then(async (result) => {
        if (result.isConfirmed) {
          const res = await fetch(`/api/delete_variant/${id}`, {
            method: 'DELETE'
          });
          const data = await res.json();
          if (data.success) {
            Swal.fire('Cancellato!', 'La variante è stata rimossa.', 'success').then(() => {
              location.reload();
            });
          } else {
            Swal.fire('Errore', 'Impossibile cancellare la variante.', 'error');
          }
        }
      });
    });
  });
</script>


{% endblock %}
