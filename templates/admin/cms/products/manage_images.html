{% extends "/admin/cms/interface/render.html" %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Gestione Immagini Section -->
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Gestione Immagini</h5>
            <span class="badge bg-info">Trascina per ordinare - Seleziona la principale</span>
        </div>
        <div class="card-body">
            <label class="form-label">Carica nuove immagini</label>
            <input type="file" id="image-upload" name="images[]" class="form-control" multiple accept="image/*">
            <div id="image-preview-carousel" class="d-flex flex-wrap gap-3 mt-4">
                {% for img in images %}
                <div class="image-box" draggable="false" data-image-id="{{ img.id }}">
                    <img src="{{ img.url }}" alt="img">
                    {% if img.is_main %}
                    <div class="main-badge">Principale</div>
                    {% else %}
                    <button class="btn-main" onclick="setMainImage({{ img.id }})">Imposta Principale</button>
                    {% endif %}
                    <button class="btn-delete" onclick="deleteImage({{ img.id }})">X</button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
#image-preview-carousel {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}
.image-box {
    position: relative;
    width: 180px;
}
.image-box img {
    width: 100%;
    height: auto;
    border-radius: 6px;
}
.image-box .main-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: #ffc107;
    color: #000;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
}
.image-box .btn-delete {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 0.75rem;
}
.image-box .btn-main {
    position: absolute;
    bottom: 8px;
    left: 8px;
    background: rgba(0, 123, 255, 0.9);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 0.75rem;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const imageInput = document.getElementById('image-upload');

    imageInput.addEventListener('change', function() {
        const files = imageInput.files;
        if (!files.length) return;

        const formData = new FormData();
        for (const file of files) {
            formData.append("images[]", file);
        }

        fetch(`/admin/cms/products/upload_image/{{ product.id }}`, {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert("Errore: " + data.error);
            }
        })
        .catch(err => console.error("Upload error:", err));
    });
});

function setMainImage(imageId) {
    fetch(`/api/set_main_image/${imageId}`, { method: 'POST' })
        .then(res => res.ok ? location.reload() : alert("Errore nel set principale"));
}

function deleteImage(imageId) {
    Swal.fire({
        title: 'Sei sicuro?',
        text: "L'immagine verrà eliminata definitivamente.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sì, elimina!'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/delete_image/${imageId}`, { method: 'POST' })
                .then(res => res.ok ? location.reload() : Swal.fire('Errore', 'Errore nella cancellazione', 'error'));
        }
    });
}
</script>

{% endblock %}