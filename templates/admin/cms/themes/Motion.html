<script>
    document.addEventListener('DOMContentLoaded', function() {
        var editor = grapesjs.init({
            container: '#editor',
            fromElement: true,
            height: '100vh',
            width: 'auto',
            storageManager: false,
            plugins: ['gjs-preset-webpage'],
            pluginsOpts: {
                'gjs-preset-webpage': {}
            },
            canvas: {
                styles: [
                    'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css',
                    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css'
                ],
                scripts: [
                    'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'
                ]
            },
        });
    



        document.getElementById('save-page').addEventListener('click', async function() {
            var content = editor.getHtml();  // Ottieni il contenuto HTML dall'editor di GrapesJS
            var slug = "{{ page.slug }}";     // Slug della pagina corrente
            var page_id = "{{ page.id }}";    // ID della pagina corrente
            var language = document.getElementById('language-selector').value; // Lingua selezionata

            if (!content) {
                Swal.fire('Error!', 'Content is empty.', 'error');
                return;
            }

            // Mostra un messaggio di caricamento
            Swal.fire({
                title: 'Saving...',
                text: 'Processing your content and uploading images.',
                icon: 'info',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading(),
            });

            // Funzione per gestire l'upload delle immagini in formato base64
            async function uploadBase64Image(base64Image) {
                try {
                    const response = await fetch('/upload-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ image: base64Image })
                    });
                    const data = await response.json();
                    if (data.url) {
                        return data.url; 
                    } else {
                        throw new Error('Image upload failed');
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    return null;
                }
            }

            // Processa tutte le immagini base64 trovate nel contenuto
            var div = document.createElement('div');
            div.innerHTML = content;
            var images = div.querySelectorAll('img');
            var uploadPromises = [];

            // Carica tutte le immagini in base64 e sostituisci i riferimenti nel contenuto
            for (let img of images) {
                if (img.src.startsWith('data:image')) {
                    const uploadPromise = uploadBase64Image(img.src).then(url => {
                        if (url) {
                            img.src = url;  
                        }
                    });
                    uploadPromises.push(uploadPromise);
                }
            }

            // Aspetta che tutte le immagini siano caricate e sostituite
            await Promise.all(uploadPromises);

            // Salva il contenuto nella tabella `pages`, identificando la lingua
            fetch("{{ url_for('page.save_page') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: page_id,
                    content: div.innerHTML,   // Nuovo contenuto con immagini sostituite
                    language: language        // Lingua selezionata
                })
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    Swal.fire('Saved!', 'Your page content has been successfully saved.', 'success');
                } else {
                    Swal.fire('Error!', 'There was an error saving the page content.', 'error');
                }
            }).catch(error => {
                console.error('Error:', error);
                Swal.fire('Error!', 'There was an error saving the page content.', 'error');
            });
        });
    });
</script>