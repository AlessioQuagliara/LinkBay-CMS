<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkBay-CMS - {{ title }}</title>
    {% include 'admin/cms/heading/admin_head.html' %}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">
    <style>
        /* Stili generali */
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            position: fixed;
            height: 100vh;
            padding: 15px;
        }
        .content-container {
            margin-left: 250px;
            padding: 20px;
            display: flex;
            flex-direction: column; /* Cambiato da row a column */
            gap: 20px; /* Aggiunto un gap tra i contenitori */
            height: auto; /* Altezza dinamica in base al contenuto */
        }
        .hidden-col {
            display: none;
        }
        .table {
            border-collapse: separate !important; /* Disattiva il comportamento predefinito */
            border-spacing: 0; /* Evita spazi tra le celle */
            border-radius: 10px !important;
            overflow: hidden; /* Assicura che il border-radius venga applicato */
        }
    </style>
</head>
<body>
<!---------------------------- Sidebar ---------------------------->
{% include 'admin/cms/ui/sidebar.html' %}

<!--------------------- Container principale --------------------->
<div class="content-container" data-aos="fade-up">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/toolbar.css') }}">

<!-- Card per la gestione della Navbar -->
<div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex gap-3">
            <a href="/admin/cms/pages/navbar" class="btn {% if title == 'Navbar Settings' %}btn-dark{% else %}btn-outline-dark{% endif %} btn-sm text-decoration-none">
                <i class="fa-solid fa-box"></i> Navbar Links
            </a>
        </div>
        <div class="custom-toolbar">

            <!-- Aggiungi nuovo link -->
            <button class="custom-btn" id="add-link" title="Add Link">
                <i class="fa-solid fa-plus"></i>
            </button>

            <!-- Elimina selezionati -->
            <button class="custom-btn delete-selected" id="delete-selected" title="Delete">
                <i class="fa-solid fa-trash"></i>
            </button>

        </div>
    </div>
</div>

    <!---------------------- Tabella Navbar ---------------------->
    <div>
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle text-center" style="border-radius: 10px !important;">
                <!-- Nella sezione <thead> -->
                <thead class="table-dark">
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Label</th>
                        <th>URL</th>
                        <th class="hidden-col">Type</th>
                        <th class="hidden-col">Parent ID</th>
                        <th class="hidden-col">Position</th>
                    </tr>
                </thead>


                <!-- E nel <tbody> ogni cella per link_type e parent_id con la classe "hidden-col" -->
                <tbody id="navbar-links">
                    {% for link in navbar_links %}
                    <tr data-id="{{ link.id }}">
                        <td><input type="checkbox" class="select-link"></td>
                        <td><input type="text" class="form-control" value="{{ link.link_text }}"></td>
                        <td><input type="text" class="form-control url-input" data-bs-toggle="modal" data-bs-target="#urlSelectorModal" value="{{ link.link_url }}" readonly></td>
                        <td class="hidden-col">
                            <select class="form-select">
                                <option value="standard" {% if link.link_type == 'standard' %}selected{% endif %}>Standard</option>
                                <option value="dropdown" {% if link.link_type == 'dropdown' %}selected{% endif %}>Dropdown</option>
                                <option value="external" {% if link.link_type == 'external' %}selected{% endif %}>External</option>
                                <option value="action" {% if link.link_type == 'action' %}selected{% endif %}>Action</option>
                            </select>
                        </td>
                        <td class="hidden-col"><input type="number" class="form-control" value="{{ link.parent_id }}"></td>
                        <td class="position hidden-col">{{ link.position }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
 <!--------------------------------------------- Modal per la selezione dell'URL ------------------------------------------>
<div class="modal fade" id="urlSelectorModal" tabindex="-1" aria-labelledby="urlSelectorLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="urlSelectorLabel">Select Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="urlTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="pages-tab" data-bs-toggle="tab" data-bs-target="#pages" type="button" role="tab">üìÑ Pages</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="commands-tab" data-bs-toggle="tab" data-bs-target="#commands" type="button" role="tab">‚öôÔ∏è Command</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="shop-actions-tab" data-bs-toggle="tab" data-bs-target="#shop-actions" type="button" role="tab">üè™ Actions</button>
                    </li>
                </ul>
                <div class="tab-content mt-3">
                    <!-- Sezione Pagine -->
                    <div class="tab-pane fade show active" id="pages" role="tabpanel">
                        <ul id="pages-list" class="list-group"></ul>
                    </div>
                    <!-- Sezione Comandi -->
                    <div class="tab-pane fade" id="commands" role="tabpanel">
                        <ul class="list-group">
                            <li class="list-group-item select-url" data-url="show_collections">üìÇ Show Collections</li>
                        <!--<li class="list-group-item select-url" data-url="show_brands">üè∑Ô∏è Show Brands</li>-->
                        </ul>
                    </div>
                    <!-- Sezione Azioni Shop -->
                    <div class="tab-pane fade" id="shop-actions" role="tabpanel">
                        <ul class="list-group">
                            <li class="list-group-item select-url" data-url="cart">üõí Cart</li>
                            <li class="list-group-item select-url" data-url="account">üë§ Account</li>
                            <li class="list-group-item select-url" data-url="search">üîç Search</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-------------------------------- Gestione di SortableJS e aggiornamento delle posizioni -------------------------------->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Abilita il drag-and-drop con SortableJS
        new Sortable(document.getElementById('navbar-links'), {
            animation: 150,
            onEnd: function () {
                updatePositions();
            }
        });

        // Funzione per aggiornare le posizioni nella colonna "Position"
        function updatePositions() {
            document.querySelectorAll("#navbar-links tr").forEach((row, index) => {
                row.querySelector(".position").textContent = index + 1;
            });
        }
    });
</script>

<!------------------------------------- Gestione dei pulsanti: selezione e aggiunta ------------------------------------->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Seleziona o deseleziona tutti i checkbox
        document.getElementById("select-all").addEventListener("change", function () {
            document.querySelectorAll(".select-link").forEach(el => el.checked = this.checked);
        });

        // Aggiunge un nuovo link con valori predefiniti
        document.getElementById("add-link").addEventListener("click", function () {
            Swal.fire({
                title: 'Adding link...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            fetch("/api/add-navbar-link", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    link_text: "New Link",
                    link_url: "/link",
                    link_type: "standard",
                    parent_id: null,
                    position: document.querySelectorAll("#navbar-links tr").length + 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Link Added!',
                        text: 'A new link has been successfully added.',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.error || 'Failed to add the link.',
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred while adding the link.',
                });
                console.error("Error:", error);
            });
        });
    });
</script>

<!--------------------------------------- Gestione Modale e Popolamento --------------------------------------->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let selectedUrlInput = null;
    
        // Apri il modale e salva il riferimento all'input cliccato
        document.querySelectorAll(".url-input").forEach(input => {
            input.addEventListener("click", function () {
                selectedUrlInput = this;
                loadPages();
            });
        });
    
        // Quando si seleziona un URL, lo imposta nell'input e chiude il modale
        document.querySelectorAll(".select-url").forEach(item => {
            item.addEventListener("click", function () {
                if (selectedUrlInput) {
                    selectedUrlInput.value = this.dataset.url;
                    let modal = bootstrap.Modal.getInstance(document.getElementById('urlSelectorModal'));
                    modal.hide();
                }
            });
        });
    
        // Funzione per caricare le pagine pubblicate con AJAX
        function loadPages() {
            fetch("/api/get-pages")
                .then(response => response.json())
                .then(data => {
                    let list = document.getElementById("pages-list");
                    list.innerHTML = "";
                    if (data.success) {
                        data.pages.forEach(page => {
                            let li = document.createElement("li");
                            li.className = "list-group-item select-url";
                            li.dataset.url = "/" + page.slug;
                            li.textContent = "üìÑ " + page.slug;
                            li.addEventListener("click", function () {
                                if (selectedUrlInput) {
                                    selectedUrlInput.value = this.dataset.url;
                                    let modal = bootstrap.Modal.getInstance(document.getElementById('urlSelectorModal'));
                                    modal.hide();
                                }
                            });
                            list.appendChild(li);
                        });
                    }
                });
        }
    });
</script>
<!--------------------------------------- Gestione di eliminazione e salvataggio --------------------------------------->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Elimina i link selezionati
        document.getElementById("delete-selected").addEventListener("click", function () {
            let selectedIds = Array.from(document.querySelectorAll(".select-link:checked"))
                .map(el => el.closest("tr").dataset.id);

            if (selectedIds.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Selection',
                    text: 'Please select at least one link to delete.',
                });
                return;
            }

            Swal.fire({
                title: 'Are you sure?',
                text: "This action cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete them!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleting links...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    fetch("/api/delete-navbar-links", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ ids: selectedIds })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                text: 'The selected links have been deleted.',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: data.error || 'Failed to delete the links.',
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'An error occurred while deleting the links.',
                        });
                        console.error("Error:", error);
                    });
                }
            });
        });

        // Salvataggio modifiche
        document.getElementById("save-content").addEventListener("click", function () {
            let navbarLinks = Array.from(document.querySelectorAll("#navbar-links tr")).map((row, index) => ({
                id: row.dataset.id || null,
                link_text: row.cells[1]?.querySelector("input")?.value.trim() || "", // Ora prende correttamente Link Text
                link_url: row.cells[2]?.querySelector("input")?.value.trim() || "",  // Ora prende correttamente URL
                link_type: row.cells[3]?.querySelector("select")?.value || "standard", // Tipo
                parent_id: row.cells[4]?.querySelector("input")?.value || null, // Parent ID
                position: index + 1 // Posizione
            }));

            // Mostra il loader con Swal2
            Swal.fire({
                title: 'Saving changes...',
                text: 'Please wait while your changes are being saved.',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // Effettua la richiesta fetch per salvare i dati
            fetch("/api/save-navbar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ navbar_links: navbarLinks })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Saved!',
                        text: 'Your changes have been successfully saved.',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.error || 'Failed to save the changes.',
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred while saving the changes.',
                });
                console.error("Error:", error);
            });
        });
    });
</script>

{% include 'admin/cms/footing/admin_footing.html' %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let navbarList = document.getElementById('navbar-links');
    
        new Sortable(navbarList, {
            animation: 150,
            group: 'nested',
            fallbackOnBody: true,
            swapThreshold: 0.65,
            onEnd: function () {
                updateLinkHierarchy();
            }
        });
    
        function updateLinkHierarchy() {
            document.querySelectorAll("#navbar-links tr").forEach((row, index) => {
                let parentRow = row.closest('tbody').closest('tr'); // Trova se ha un genitore
                let parentIdInput = row.querySelector("td:nth-child(5) input"); // Input nascosto parent_id
                let linkTypeSelect = row.querySelector("td:nth-child(4) select"); // Select per il tipo di link
    
                row.dataset.position = index + 1; // Aggiorna posizione
    
                if (parentRow) {
                    // Se ha un genitore, aggiorna parent_id e imposta il genitore come dropdown
                    parentIdInput.value = parentRow.dataset.id;
                    parentRow.querySelector("td:nth-child(4) select").value = "dropdown";
                } else {
                    // Se √® un link principale, resetta parent_id e torna standard
                    parentIdInput.value = "";
                    if (linkTypeSelect.value === "dropdown") {
                        linkTypeSelect.value = "standard";
                    }
                }
            });
        }
    });
    </script>
</body>
</html>