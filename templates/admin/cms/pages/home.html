{% extends "/admin/cms/interface/render.html" %}

{% block content %}
<div class="row" data-aos="fade-up"></div>
        <div id="assistant-container" class="rounded-3 mb-3">
          <div class="card-body">
              <img class="mb-4" src="https://www.linkbay.it/static/image/lb-logo.svg" width="130px" alt="Logo LinkBay">
              <span class="card-title text-center mb-3">AI Assistant</span>
              
              <!-- Chat Box -->
              <div id="chat-box" class="border rounded p-3 mb-3" style="height: 300px; overflow-y: auto; background: #f8f9fa;">
                  <!-- I messaggi della chat verranno aggiunti qui -->
              </div>

              <!-- Input Box -->
              <div class="input-group">
                  <input type="text" id="user-input" class="form-control" placeholder="Ask anything..." aria-label="User input">
                  <button id="send-btn" class="btn btn-danger">Send</button>
              </div>
          </div>
        </div>

        <script>
          // Carica la chat salvata da localStorage al caricamento della pagina
          document.addEventListener("DOMContentLoaded", function() {
              loadChatHistory();
          });

          // Funzione per salvare la chat corrente in localStorage
          function saveChatHistory() {
              const chatBox = document.getElementById("chat-box");
              localStorage.setItem("chatHistory", chatBox.innerHTML);
          }

          // Funzione per caricare la chat da localStorage
          function loadChatHistory() {
              const chatBox = document.getElementById("chat-box");
              const savedChat = localStorage.getItem("chatHistory");
              if (savedChat) {
                  chatBox.innerHTML = savedChat;
                  chatBox.scrollTop = chatBox.scrollHeight;
              }
          }

          // Funzione che esegue l'invio del messaggio
          async function sendMessage() {
              const userInputField = document.getElementById('user-input');
              const userInput = userInputField.value.trim();
              if (!userInput) {
                  alert("Please enter a valid query.");
                  return;
              }
              
              const chatBox = document.getElementById('chat-box');

              // Aggiunge il messaggio utente alla chat
              const userMessage = document.createElement("div");
              userMessage.classList.add("alert", "alert-danger", "p-2");
              userMessage.innerHTML = `<strong>You:</strong> ${userInput}`;
              chatBox.appendChild(userMessage);
              chatBox.scrollTop = chatBox.scrollHeight;  // Scroll automatico
              saveChatHistory();

              // Prepara il messaggio del bot con il container per l'animazione
              const botMessage = document.createElement("div");
              botMessage.classList.add("alert", "alert-secondary", "p-2");
              const typingSpan = document.createElement("span");
              botMessage.innerHTML = `<strong>LinkBay AI:</strong> `;
              botMessage.appendChild(typingSpan);
              chatBox.appendChild(botMessage);
              chatBox.scrollTop = chatBox.scrollHeight;
              saveChatHistory();

              // Resetta il campo input
              userInputField.value = "";

              // Avvia l'animazione dei tre puntini (simile a WhatsApp)
              let dotInterval = setInterval(() => {
                  if (typingSpan.innerHTML.length < 3) {
                      typingSpan.innerHTML += '.';
                  } else {
                      typingSpan.innerHTML = '';
                  }
              }, 500);

              try {
                  const response = await fetch('/assistant', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ query: userInput })
                  });
                  
                  const data = await response.json();
                  
                  // Ferma l'animazione dei puntini
                  clearInterval(dotInterval);
                  
                  if (response.ok) {
                      // Anima la scrittura della risposta lettera per lettera
                      typeText(typingSpan, data.response, () => {
                          botMessage.innerHTML = `<strong>LinkBay AI:</strong> ${data.response}`;
                          chatBox.scrollTop = chatBox.scrollHeight;  // Scroll automatico dopo risposta
                          saveChatHistory();
                      });
                  } else {
                      botMessage.innerHTML = `<strong>LinkBay AI:</strong> <span class="text-danger">Error processing your request.</span>`;
                      saveChatHistory();
                  }
              } catch (error) {
                  console.error("Error:", error);
                  botMessage.innerHTML = `<strong>LinkBay AI:</strong> <span class="text-danger">An unexpected error occurred.</span>`;
                  saveChatHistory();
              }
              
              chatBox.scrollTop = chatBox.scrollHeight;  // Scroll automatico
          }

          // Collega il tasto send al click
          document.getElementById('send-btn').addEventListener('click', sendMessage);

          // Collega l'evento "Enter" sul campo input
          document.getElementById('user-input').addEventListener('keydown', function(event) {
              if (event.key === 'Enter') {
                  event.preventDefault();
                  sendMessage();
              }
          });

          // Funzione per animare il typing (digitazione lettera per lettera)
          function typeText(element, text, callback) {
              let i = 0;
              element.innerHTML = "";  // Resetta il testo
              
              function type() {
                  if (i < text.length) {
                      element.innerHTML += text.charAt(i);
                      i++;
                      setTimeout(type, 30);  // VelocitÃ  di digitazione (30ms per carattere)
                  } else if (callback) {
                      callback();
                  }
              }
              type();
          }
        </script>


        
            <div class="col-12 mb-3 ">
                <button type="button" class="btn btn-dark btn-sm"><i class="fa-solid fa-inbox"></i> Orders to be Processed <span class="badge text-bg-secondary">0</span></button>
                <button type="button" class="btn btn-dark btn-sm">Orders to Ship</button>
            </div>
            <div class="col-md-12 mb-3">
              <style>
                  .store-card {
                      position: relative;
                      height: 180px; /* Altezza ridotta per maggiore compattezza */
                      overflow: hidden;
                      border-radius: 10px; /* Bordi arrotondati */
                  }
                  .store-card .card-img {
                      height: 100%;
                      object-fit: cover;
                      filter: brightness(45%); /* Effetto opaco */
                  }
                  .store-card .card-img-overlay {
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      color: white;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      align-items: flex-start; /* Allinea il contenuto a sinistra */
                      padding: 15px;
                  }
                  .store-card .card-title {
                      font-size: 1.3rem;
                      font-weight: bold;
                  }
                  .store-card .card-text {
                      font-size: 0.95rem;
                      margin-bottom: 0.5rem;
                  }
                  .store-card .btn-small {
                      padding: 0.35rem 0.75rem;
                      font-size: 0.85rem;
                      border-radius: 5px;
                  }
                  .store-card .form-check-input:checked {
                      background-color: #ff5757 !important;
                      border-color: #ff5757 !important;
                  }
              </style>
          
              <div class="card store-card text-bg-dark shadow">
                  <img src="https://www.linkbay.it/static/image/store_image.webp" 
                      class="card-img" 
                      alt="Store Image">
                  <div class="card-img-overlay">
                      <h5 class="card-title">Your Online Store</h5>
                      <p class="card-text">
                          <i class="fa-regular fa-circle-dot text-danger"></i> 
                          <strong id="active-visitors">0</strong> Visitors Today
                      </p>
                      <p class="card-text"><small id="last-update">Waiting for update...</small></p>
                      <div class="d-flex gap-2">
                          <a href="../../../" target="_blank" class="btn btn-light btn-small">View Online Store</a>
                          <a href="{{ url_for('page.editor_interface') }}" class="btn btn-danger btn-small">Edit Store</a>
                      </div>
                  </div>
              </div>
          
              <script>
                document.addEventListener("DOMContentLoaded", function () {
                    function updateVisitors() {
                        fetch("/api/get-site-visits")
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    const visitorsCount = data.visits.length;
                                    document.getElementById("active-visitors").textContent = visitorsCount;
                                    document.getElementById("last-update").textContent = "Last updated " + new Date().toLocaleTimeString();
            
                                    // Aggiorna la lista delle visite recenti
                                    const visitsList = document.getElementById("visitors-list");
                                    if (visitsList) {
                                        visitsList.innerHTML = ""; // Svuota la lista prima di aggiornare
                                        data.visits.forEach(visit => {
                                            const visitElement = document.createElement("li");
                                            visitElement.classList.add("list-group-item");
                                            visitElement.innerHTML = `
                                                <strong>${visit.ip_address}</strong> 
                                                - <small>${visit.page_url}</small> 
                                                <span class="text-muted">(${new Date(visit.visit_time).toLocaleTimeString()})</span>
                                            `;
                                            visitsList.appendChild(visitElement);
                                        });
                                    }
                                } else {
                                    console.error("Error:", data.error);
                                }
                            })
                            .catch(error => console.error("Error fetching visitor data:", error));
                    }
            
                    updateVisitors();  // Aggiorna subito alla pagina load
                    setInterval(updateVisitors, 10000);  // Aggiorna ogni 10 secondi
                });
            </script>
          </div>
            <div class="col-12 mb-3">
                <div class="accordion" id="accordionPanelsStayOpenExample">
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                          Brief Guide
                        </button>
                      </h2>
                      <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                          <strong>Welcome to your online shop! </strong> Create an innovative design to stand out from the crowd with our 360Â° editor, get help from experts if you canât do it yourself. Add your products, set up shipping, payment methods and start selling!
                        </div>
                      </div>
                    </div>
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                          How To Sell
                        </button>
                      </h2>
                      <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul class="list-group">
                                <li class="list-group-item"><input class="form-check-input" type="checkbox" >&nbsp;  Add your first product &nbsp;<a href="products" class="btn btn-small btn-danger"><i class="fa-solid fa-share-from-square"></i></a></li>
                                <li class="list-group-item"><input class="form-check-input" type="checkbox" >&nbsp;  Customize your own store &nbsp;<a href="online-content" class="btn btn-small btn-danger"><i class="fa-solid fa-share-from-square"></i></a></li>
                                <li class="list-group-item"><input class="form-check-input" type="checkbox" >&nbsp;  Get your own internet domain &nbsp;<a href="domain" class="btn btn-small btn-danger"><i class="fa-solid fa-share-from-square"></i></a></li>
                                <li class="list-group-item"><input class="form-check-input" type="checkbox" >&nbsp;  Enter shipping details &nbsp;<a href="shipping" class="btn btn-small btn-danger"><i class="fa-solid fa-share-from-square"></i></a></li>
                                <li class="list-group-item"><input class="form-check-input" type="checkbox" >&nbsp;  Enter the payment system &nbsp;<a href="" class="btn btn-small btn-danger"><i class="fa-solid fa-share-from-square"></i></a></li>
                              </ul>
                        </div>
                      </div>
                    </div>
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                          Start to Sell
                        </button>
                      </h2>
                      <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse">
                        <div class="accordion-body">
                          Subscribe a subscription plan with us to be able to use your online store for sale. &nbsp;<a href="" class="btn btn-small btn-danger"><i class="fa-solid fa-share-from-square"></i></a>
                        </div>
                      </div>
                    </div>
                  </div>
            </div>
        </div>
  
        <br><br><br><br><br>


{% endblock %}