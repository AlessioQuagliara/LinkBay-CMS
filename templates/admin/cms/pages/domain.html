{% extends "/admin/cms/interface/render.html" %}

{% block content %}

{% if shop.name %}

<div class="container my-4" data-aos="fade-up">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark d-flex justify-content-between align-items-center">
            <h6 class="text-white mb-0">Manage Domain</h6>
            <i class="fa-solid fa-globe fa-2x text-white"></i>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <h5 class="text-dark">Current Domain</h5>
                <p class="text-muted">View and manage your current domain.</p>
                <form id="domain-manage-form" class="needs-validation" novalidate>
                    <div class="input-group mb-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="currentDomainInput" 
                            name="current_domain_name" 
                            value="{{ shop.domain }}" 
                            readonly>
                        <button type="button" id="manageDomain" class="btn btn-primary">
                            <i class="fa-solid fa-cog me-2"></i> Manage
                        </button>
                    </div>
                </form>
                <div class="input-group-append">
                    <span class="input-group-text"> Domain status: valid &nbsp;<i class="fa-solid fa-circle text-success"></i></span>
                </div>
                <div class="input-group-append mt-3">
                    <button type="button" id="renewDomain" class="btn btn-warning">
                        <i class="fa-solid fa-sync me-2"></i> Renew Domain (Expires on: {{ shop.domain_expiry_date }})
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>



{% else %}

<div class="container my-4" data-aos="fade-up">
    <!-- Domain Management Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark d-flex justify-content-between align-items-center">
            <h6 class="text-white mb-0">Domain Search and Purchase</h6>
            <i class="fa-solid fa-globe fa-2x text-white"></i>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <h5 class="text-dark">Search for a Domain</h5>
                <p class="text-muted">Enter a domain name to check availability and purchase.</p>
                <form id="domain-search-form" class="needs-validation" novalidate>
                    <div class="input-group mb-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="domainSearchInput" 
                            name="domain_name" 
                            placeholder="example.com" 
                            required>
                        <button type="button" id="searchDomain" class="btn btn-primary">
                            <i class="fa-solid fa-search me-2"></i> Search
                        </button>
                    </div>
                    <div class="invalid-feedback">
                        Please provide a valid domain name.
                    </div>
                </form>
            </div>

            <!-- Risultati della ricerca -->
            <div id="domain-results" class="mt-4 d-none">
                <h5 class="text-dark">Available Domains</h5>
                <p class="text-muted">Choose a domain from the list below to purchase.</p>
                <ul class="list-group" id="domain-results-list"></ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal per Inserire Dati -->
<div class="modal fade" id="domainPurchaseModal" tabindex="-1" aria-labelledby="domainPurchaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Header del Modale -->
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="domainPurchaseModalLabel">Complete Purchase Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Corpo del Modale -->
            <div class="modal-body">
                <form id="domainPurchaseForm">
                    <!-- Nome Dominio (Hidden) -->
                    <input type="hidden" id="purchaseDomainName" name="domain_name">
                    
                    <!-- Nome Admin -->
                    <div class="mb-3">
                        <label for="adminFirstName" class="form-label">Admin First Name</label>
                        <input type="text" class="form-control" id="adminFirstName" name="admin_first_name" 
                            placeholder="Enter first name" 
                            required>
                        <div class="invalid-feedback">Please provide a valid first name.</div>
                    </div>
                    
                    <!-- Cognome Admin -->
                    <div class="mb-3">
                        <label for="adminLastName" class="form-label">Admin Last Name</label>
                        <input type="text" class="form-control" id="adminLastName" name="admin_last_name" 
                            placeholder="Enter last name" 
                            required>
                        <div class="invalid-feedback">Please provide a valid last name.</div>
                    </div>
                    
                    <!-- Email Admin -->
                    <div class="mb-3">
                        <label for="adminEmail" class="form-label">Admin Email</label>
                        <input type="email" class="form-control" id="adminEmail" name="admin_email" 
                            placeholder="Enter email address" 
                            required>
                        <div class="invalid-feedback">Please provide a valid email address.</div>
                    </div>
                    
                    <!-- Telefono Admin -->
                    <div class="mb-3">
                        <label for="adminPhone" class="form-label">Admin Phone</label>
                        <input type="text" class="form-control" id="adminPhone" name="admin_phone" 
                            placeholder="+1.1234567890" 
                            pattern="^\+([0-9]){1,3}\.([0-9]\ ?){5,14}$" 
                            title="Format: +1.1234567890" 
                            required>
                        <div class="invalid-feedback">Please provide a valid phone number (e.g., +1.1234567890).</div>
                    </div>
                    
                    <!-- Indirizzo Admin -->
                    <div class="mb-3">
                        <label for="adminAddress" class="form-label">Admin Address</label>
                        <input type="text" class="form-control" id="adminAddress" name="admin_address" 
                            placeholder="Enter address" 
                            required>
                        <div class="invalid-feedback">Please provide a valid address.</div>
                    </div>
                    
                    <!-- CittÃ  Admin -->
                    <div class="mb-3">
                        <label for="adminCity" class="form-label">Admin City</label>
                        <input type="text" class="form-control" id="adminCity" name="admin_city" 
                            placeholder="Enter city" 
                            required>
                        <div class="invalid-feedback">Please provide a valid city.</div>
                    </div>
                    
                    <!-- Codice Postale Admin -->
                    <div class="mb-3">
                        <label for="adminPostalCode" class="form-label">Admin Postal Code</label>
                        <input type="text" class="form-control" id="adminPostalCode" name="admin_postal_code" 
                            placeholder="Enter postal code" 
                            required>
                        <div class="invalid-feedback">Please provide a valid postal code.</div>
                    </div>
                    
                    <!-- Paese Admin -->
                    <div class="mb-3">
                        <label for="adminCountry" class="form-label">Admin Country</label>
                        <select class="form-select" id="adminCountry" name="admin_country" required>
                            <option value="" disabled selected>Select Country</option>
                            <option value="US">United States</option>
                            <option value="IT">Italy</option>
                            <option value="GB">United Kingdom</option>
                            <option value="FR">France</option>
                            <option value="DE">Germany</option>
                            <option value="ES">Spain</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <!-- Altri paesi possono essere aggiunti qui -->
                        </select>
                        <div class="invalid-feedback">Please select a country.</div>
                    </div>
                    
                    <!-- Stato Admin -->
                    <div class="mb-3">
                        <label for="adminState" class="form-label">Admin State</label>
                        <input type="text" class="form-control" id="adminState" name="admin_state" 
                            placeholder="Enter state/province" 
                            required>
                        <div class="invalid-feedback">Please provide a valid state or province.</div>
                    </div>
                </form>
            </div>
            
            <!-- Footer del Modale -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmPurchase">Confirm Purchase</button>
            </div>
        </div>
    </div>
</div>

{% endif %}


<script>
document.addEventListener('DOMContentLoaded', () => {
    // Elementi del DOM
    const domainSearchInput = document.getElementById('domainSearchInput');
    const domainResults = document.getElementById('domain-results');
    const domainResultsList = document.getElementById('domain-results-list');
    const purchaseDomainInput = document.getElementById('purchaseDomainName');
    const confirmPurchaseButton = document.getElementById('confirmPurchase');
    const purchaseForm = document.getElementById('domainPurchaseForm');

    // Funzione per gestire la ricerca del dominio
    const searchDomain = () => {
        const domainName = domainSearchInput.value.trim();

        if (!domainName) {
            Swal.fire('Validation Error', 'Please enter a valid domain name.', 'error');
            return;
        }

        Swal.fire({
            title: 'Searching...',
            text: 'Please wait while we search for domain availability.',
            icon: 'info',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        fetch('/api/domains/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ domain_name: domainName }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            Swal.close();
            if (data.success && data.domains.length > 0) {
                displayDomainResults(data.domains);
            } else {
                Swal.fire('No Domains Found', 'No available domains were found with the given name.', 'warning');
                domainResults.classList.add('d-none');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'A network or server error occurred.', 'error');
        });
    };

    // Funzione per mostrare i risultati della ricerca
    const displayDomainResults = (domains) => {
        domainResults.classList.remove('d-none');
        domainResultsList.innerHTML = '';

        domains.forEach(domain => {
            const listItem = document.createElement('li');
            listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
            listItem.innerHTML = `
                <span>${domain.name}</span>
                <span>$ ${(domain.price / 1000000).toFixed(2)}</span>
                <button class="btn btn-success btn-sm purchase-domain" data-domain="${domain.name}">
                    Purchase
                </button>
            `;
            domainResultsList.appendChild(listItem);
        });

        attachPurchaseEventListeners();
    };

    // Aggiungi eventi ai pulsanti "Purchase"
    const attachPurchaseEventListeners = () => {
        document.querySelectorAll('.purchase-domain').forEach(button => {
            button.addEventListener('click', (event) => {
                const domainName = event.target.getAttribute('data-domain');
                purchaseDomainInput.value = domainName;
                const modal = new bootstrap.Modal(document.getElementById('domainPurchaseModal'));
                modal.show();
            });
        });
    };

    // Funzione per completare l'acquisto del dominio
    const purchaseDomain = () => {
        const formData = new FormData(purchaseForm);

        Swal.fire({
            title: 'Processing Purchase...',
            text: 'Please wait while we complete your purchase.',
            icon: 'info',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        fetch('/api/domains/purchase', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            Swal.close();
            if (data.success) {
                Swal.fire({
                    title: 'Success',
                    text: 'Domain purchased successfully.',
                    icon: 'success',
                }).then(() => {
                    purchaseForm.reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('domainPurchaseModal'));
                    modal.hide();
                    domainResultsList.innerHTML = ''; // Pulisce i risultati
                    domainResults.classList.add('d-none');
                });
            } else {
                Swal.fire('Error', data.message || 'Failed to purchase domain.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'A network or server error occurred.', 'error');
        });
    };

    // Event listener per il pulsante di ricerca
    document.getElementById('searchDomain').addEventListener('click', searchDomain);

    // Event listener per il pulsante di conferma dell'acquisto
    confirmPurchaseButton.addEventListener('click', purchaseDomain);
});
</script>

{% endblock %}