{% extends "/admin/cms/interface/render.html" %}

{% block content %}
<!-- CONTENUTO -->

{% if order and order.shop_name == shop_subdomain %}
<div class="container my-4" data-aos="fade-up">

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark">
            <h6 class="text-white mb-0">Products in Order</h6>
        </div>
        <div class="card-body">
            {% if order and order.order_items %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">
                                    <input type="checkbox" id="select-all" class="form-check-input">
                                </th>
                                <th scope="col">Product</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Price</th>
                                <th scope="col">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="product-list">
                            {% for item in order.order_items %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input product-checkbox" data-product-id="{{ item.product_id }}">
                                </td>
                                <td>{{ item.product.name }}</td>  
                                <td>
                                    <input type="number" class="form-control quantity-input" value="{{ item.quantity }}" min="1" data-item-id="{{ item.id }}">
                                </td>
                                <td>€ {{ item.price }}</td>
                                <td>€ {{ item.subtotal }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No products associated with this order.</p>
            {% endif %}
        </div>
    </div>

</div>
{% else %}
<div class="d-flex align-items-center justify-content-center vh-100 bg-light">
    <div class="text-center">
        <h1 class="display-4 fw-bold text-muted">Content Unavailable</h1>
        <p class="lead text-secondary">
            The content you are looking for is currently unavailable. Please check back later or contact support for assistance.
        </p>
    </div>
</div>
{% endif %}

<!-- Modal for Adding Products -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Add Products to Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Search Bar -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="searchProductInput" placeholder="Search products...">
                    <button class="btn btn-primary" id="searchProductButton">
                        <i class="fa-solid fa-search"></i> Search
                    </button>
                </div>
                <!-- Search Results Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="searchResults">
                            <tr>
                                <td colspan="3" class="text-center text-muted">No products found. Use the search bar above.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="order-data" data-order-id="{{ order.id }}"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const orderDataElement = document.getElementById('order-data');

    if (orderDataElement && orderDataElement.dataset.orderId) {
        const orderId = orderDataElement.dataset.orderId;
        console.log("Order ID:", orderId);
    } else {
        console.error("Order ID not found. Check if the #order-data element exists and contains a valid data-order-id attribute.");
    }
});
</script>

<script>
// Apertura del Modale e Ricerca Prodotti
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchProductInput');
    const searchButton = document.getElementById('searchProductButton');
    const searchResults = document.getElementById('searchResults');

    // Ricerca prodotti
    searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (!query) {
            Swal.fire('Error', 'Please enter a search term.', 'error');
            return;
        }

        fetch(`/admin/cms/search_products?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.products.length > 0) {
                    searchResults.innerHTML = data.products.map(product => `
                        <tr>
                            <td>${product.name}</td>
                            <td>€ ${product.price}</td>
                            <td>
                                <button class="btn btn-success btn-sm add-product-btn" data-id="${product.id}">
                                    <i class="fa-solid fa-plus"></i> Add
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    searchResults.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center text-muted">No products found.</td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching products:', error);
                Swal.fire('Error', 'An error occurred while searching for products.', 'error');
            });
    });

    // Delegazione evento per pulsanti "Add"
    searchResults.addEventListener('click', (e) => {
        if (e.target.closest('.add-product-btn')) {
            const button = e.target.closest('.add-product-btn');
            const productId = button.dataset.id;
            const orderId = document.getElementById('order-data').dataset.orderId;

            if (!productId || !orderId) {
                Swal.fire('Error', 'Order ID or Product ID is missing.', 'error');
                return;
            }

            fetch('/api/add_product_to_order_from_table', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: orderId, product_id: productId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Success', 'Product added to the order.', 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Failed to add product.', 'error');
                });
        }
    });
});
</script>

<script>
    // AGGIUNTA DEI PRODOTTI SULL'ORDINE -----------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
    const addButtons = document.querySelectorAll('.add-product-btn'); // Bottone per aggiungere il prodotto

    addButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const productId = button.dataset.id;
            const orderId = document.getElementById('order-data').dataset.orderId;
            const quantity = 1; // Puoi gestire dinamicamente la quantità se necessario

            if (!productId || !orderId) {
                Swal.fire('Error', 'Order ID or Product ID is missing.', 'error');
                return;
            }

            fetch('/api/add_products_to_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: orderId, product_id: productId, quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Success', 'Product added to the order.', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Failed to add product.', 'error');
            });
        });
    });
});
</script>

<script>
    // Funzione per incollare prodotti copiati
    document.addEventListener('DOMContentLoaded', () => {
    const pasteProductsButton = document.querySelector('.fa-paste').closest('a');

    pasteProductsButton.addEventListener('click', async (e) => {
        e.preventDefault();

        try {
            // Recupera gli ID dei prodotti copiati dalla sessione Flask
            const response = await fetch('/api/get_copied_products');
            const data = await response.json();

            if (!data.success || data.product_ids.length === 0) {
                Swal.fire('Error', 'No copied products found.', 'error');
                return;
            }

            const productIds = data.product_ids;

            Swal.fire({
                title: 'Adding Products...',
                text: `Adding ${productIds.length} products to the order.`,
                icon: 'info',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });

            // Invia direttamente gli ID salvati nella sessione per inserirli in OrderItems
            const addResponse = await fetch('/api/add_products_to_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_id: document.getElementById('order-data').dataset.orderId
                })
            });

            const result = await addResponse.json();
            Swal.close();

            if (result.success) {
                Swal.fire('Success', 'Products added to the order.', 'success').then(() => {
                    location.reload();
                });
            } else {
                Swal.fire('Error', result.message || 'Failed to add products.', 'error');
            }

        } catch (error) {
            console.error('Error processing products:', error);
            Swal.fire('Error', 'A network error occurred.', 'error');
        }
    });
});
</script>

<script>
// Rimozione Prodotti Selezionati
document.addEventListener('DOMContentLoaded', () => {
    const removeSelectedButton = document.querySelector('.fa-square-minus').closest('a');
    const orderId = document.getElementById('order-data').dataset.orderId;

    removeSelectedButton.addEventListener('click', (e) => {
        e.preventDefault();

        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked'))
            .map(checkbox => checkbox.dataset.productId);

        if (selectedProducts.length === 0) {
            Swal.fire('Error', 'No products selected for removal.', 'error');
            return;
        }

        Swal.fire({
            title: 'Remove Selected Products?',
            text: `Are you sure you want to remove ${selectedProducts.length} products from this order?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, remove them!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/api/remove_products_from_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId, product_ids: selectedProducts })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Removed!', 'The selected products were removed successfully.', 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Error', data.message || 'Failed to remove products.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'A network error occurred.', 'error');
                    });
            }
        });
    });
});
</script>

<script>
    // Salvataggio delle Quantità Modificate
// Salvataggio delle Quantità Modificate
document.addEventListener('DOMContentLoaded', () => {
    const saveButton = document.getElementById('save-content');
    const orderId = document.getElementById('order-data').dataset.orderId;

    saveButton.addEventListener('click', () => {
        const updatedItems = [];

        // Itera su ogni riga della tabella per raccogliere le quantità aggiornate
        document.querySelectorAll('#product-list tr').forEach(row => {
            const quantityInput = row.querySelector('.quantity-input');
            const productId = row.querySelector('.product-checkbox').dataset.productId;

            if (quantityInput && productId) {
                const quantity = parseInt(quantityInput.value, 10);
                if (!isNaN(quantity) && quantity > 0) {
                    updatedItems.push({
                        product_id: parseInt(productId),  // Assicura che sia un numero
                        quantity: quantity
                    });
                }
            }
        });

        console.log("📌 Dati inviati al backend:", {
            order_id: orderId,
            items: updatedItems
        });

        if (updatedItems.length === 0) {
            Swal.fire('Warning', 'No quantities to update.', 'warning');
            return;
        }

        Swal.fire({
            title: 'Saving Changes...',
            text: 'Please wait while we update the quantities.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();

                fetch('/api/update_order_quantities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: orderId,
                        items: updatedItems
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("📌 Risposta dal backend:", data);
                        Swal.close();
                        if (data.success) {
                            Swal.fire('Success', 'Quantities updated successfully.', 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Error', data.message || 'Failed to update quantities.', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.close();
                        console.error('❌ Errore aggiornamento quantità:', error);
                        Swal.fire('Error', 'A network error occurred.', 'error');
                    });
            }
        });
    });
});
</script>
{% endblock %}