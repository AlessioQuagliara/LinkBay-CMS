{% extends "/admin/cms/interface/render.html" %}

{% block content %}
<div class="container my-4">

    <!-- Card per le funzioni della tabella -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Products Management</h5>
            <div>
                <button class="btn btn-warning btn-sm mx-1" title="Add Product">
                    <i class="fa-solid fa-plus"></i>
                </button>

                <button class="btn btn-primary btn-sm mx-1 select-all" title="Select All">
                    <i class="fa-solid fa-check"></i>
                </button>

                <button class="btn btn-danger btn-sm mx-1 delete-selected" title="Delete">
                    <i class="fa-solid fa-trash"></i>
                </button>

                <button class="btn btn-success btn-sm mx-1" title="Export">
                    <i class="fa-solid fa-file-excel"></i>
                </button>

                <button class="btn btn-secondary btn-sm mx-1" data-bs-toggle="modal" data-bs-target="#customizationModal" id="customize-columns" title="Customize Columns">
                    <i class="fa-solid fa-cog"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Card per la tabella dei prodotti -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle text-center" style="border-radius: 10px;">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col"><input type="checkbox" id="select-all-checkbox"></th>
                            <th scope="col" class="id">#</th>
                            <th scope="col" class="name">Name</th>
                            <th scope="col" class="description">Description</th>
                            <th scope="col" class="short_description">Short Description</th>
                            <th scope="col" class="price">Price</th>
                            <th scope="col" class="discount_price">Discount Price</th>
                            <th scope="col" class="stock_quantity">Stock</th>
                            <th scope="col" class="sku">SKU</th>
                            <th scope="col" class="category">Category</th>
                            <th scope="col" class="brand">Brand</th>
                            <th scope="col" class="weight">Weight</th>
                            <th scope="col" class="dimensions">Dimensions</th>
                            <th scope="col" class="color">Color</th>
                            <th scope="col" class="material">Material</th>
                            <th scope="col" class="image_url">Image URL</th>
                            <th scope="col" class="slug">Slug</th>
                            <th scope="col" class="is_active">Is Active</th>
                            <th scope="col" class="created_at">Created At</th>
                            <th scope="col" class="updated_at">Updated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr class="table-row" data-product-id="{{ product.id }}">
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td class="id">{{ product.id }}</td>
                            <td class="name">{{ product.name }}</td>
                            <td class="description">{{ product.description }}</td>
                            <td class="short_description">{{ product.short_description }}</td>
                            <td class="price">€{{ product.price }}</td>
                            <td class="discount_price">€{{ product.discount_price }}</td>
                            <td class="stock_quantity">{{ product.stock_quantity }}</td>
                            <td class="sku">{{ product.sku }}</td>
                            <td class="category">{{ product.category_id }}</td>
                            <td class="brand">{{ product.brand_id }}</td>
                            <td class="weight">{{ product.weight }}</td>
                            <td class="dimensions">{{ product.dimensions }}</td>
                            <td class="color">{{ product.color }}</td>
                            <td class="material">{{ product.material }}</td>
                            <td class="image_url">
                                <img src="{{ product.image_url }}" alt="{{ product.name }} Image" style="max-width: 50px; max-height: 50px;">
                            </td>
                            <td class="slug">{{ product.slug }}</td>
                            <td class="is_active">{{ 'Yes' if product.is_active else 'No' }}</td>
                            <td class="created_at">{{ product.created_at }}</td>
                            <td class="updated_at">{{ product.updated_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal di configurazione -->
<div class="modal fade" id="customizationModal" tabindex="-1" aria-labelledby="customizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customizationModalLabel">Customize Table View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Columns to Display</h6>
                <div id="columns-container">
                    <!-- Opzioni delle colonne generate dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="save-customization">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const columnsContainer = document.getElementById('columns-container');
        const saveButton = document.getElementById('save-customization');
        const tableRows = document.querySelectorAll('.table-row');
        let isMouseDown = false;

        // Colonne disponibili nella tabella
        const columns = [
            { value: 'id', label: '#' },
            { value: 'name', label: 'Name', default: true },
            { value: 'description', label: 'Description', default: true },
            { value: 'short_description', label: 'Short Description' },
            { value: 'price', label: 'Price' },
            { value: 'discount_price', label: 'Discount Price', default: true },
            { value: 'stock_quantity', label: 'Stock', default: true },
            { value: 'sku', label: 'SKU', default: true },
            { value: 'category', label: 'Category' },
            { value: 'brand', label: 'Brand' },
            { value: 'weight', label: 'Weight' },
            { value: 'dimensions', label: 'Dimensions' },
            { value: 'color', label: 'Color' },
            { value: 'material', label: 'Material' },
            { value: 'image_url', label: 'Image URL' },
            { value: 'slug', label: 'Slug' },
            { value: 'is_active', label: 'Is Active', default: true },
            { value: 'created_at', label: 'Created At' },
            { value: 'updated_at', label: 'Updated At' }
        ];

        // Funzione per generare dinamicamente le opzioni delle colonne
        function renderColumnOptions(preferences) {
            columnsContainer.innerHTML = '';
            columns.forEach(column => {
                const isChecked = preferences[column.value] ?? column.default;
                columnsContainer.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="${column.value}" id="column-${column.value}" ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="column-${column.value}">${column.label}</label>
                    </div>`;
            });
        }

        // Funzione per salvare le preferenze nel localStorage
        function savePreferences() {
            const preferences = {};
            document.querySelectorAll('.column-toggle').forEach(toggle => {
                preferences[toggle.value] = toggle.checked;
            });
            localStorage.setItem('tablePreferences', JSON.stringify(preferences));
        }

        // Funzione per caricare le preferenze dal localStorage
        function loadPreferences() {
            const preferences = JSON.parse(localStorage.getItem('tablePreferences')) || {};
            renderColumnOptions(preferences);
            applyPreferences(preferences);
        }

        // Funzione per applicare le preferenze alle colonne
        function applyPreferences(preferences) {
            columns.forEach(column => {
                const isChecked = preferences[column.value] ?? column.default;
                const header = document.querySelector(`thead th.${column.value}`);
                if (header) {
                    header.style.display = isChecked ? '' : 'none';
                }
                document.querySelectorAll(`tbody td.${column.value}`).forEach(cell => {
                    cell.style.display = isChecked ? '' : 'none';
                });
            });
        }

        // Salva preferenze e nascondi il modale
        saveButton.addEventListener('click', function () {
            const preferences = {};
            document.querySelectorAll('.column-toggle').forEach(toggle => {
                preferences[toggle.value] = toggle.checked;
            });
            localStorage.setItem('tablePreferences', JSON.stringify(preferences));
            applyPreferences(preferences);
            const modal = bootstrap.Modal.getInstance(document.getElementById('customizationModal'));
            modal.hide();
        });

        // Selezione singola e multi-riga con click e drag
        tableRows.forEach(row => {
            row.addEventListener('mousedown', function(event) {
                isMouseDown = true;
                toggleRowSelection(this);
                event.preventDefault();
            });

            row.addEventListener('mouseover', function() {
                if (isMouseDown) {
                    toggleRowSelection(this);
                }
            });
        });

        document.addEventListener('mouseup', function() {
            isMouseDown = false;
        });

        // Funzione per selezionare/deselezionare una riga
        function toggleRowSelection(row) {
            const checkbox = row.querySelector('.row-checkbox');
            checkbox.checked = !checkbox.checked;
            row.classList.toggle('table-active', checkbox.checked);
        }

        // Seleziona tutte le righe
        document.querySelector('.select-all').addEventListener('click', function() {
            const allChecked = Array.from(tableRows).every(row => row.querySelector('.row-checkbox').checked);
            tableRows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                checkbox.checked = !allChecked;
                row.classList.toggle('table-active', checkbox.checked);
            });
        });

        // Checkbox per selezionare tutte le righe
        document.getElementById('select-all-checkbox').addEventListener('change', function() {
            const isChecked = this.checked;
            tableRows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                checkbox.checked = isChecked;
                row.classList.toggle('table-active', isChecked);
            });
        });

        loadPreferences();
    });
</script>

<style>
    .table-row:hover {
        background-color: rgba(0, 123, 255, 0.1);
        transition: background-color 0.2s ease-in-out;
    }
    .table-bordered {
        border-radius: 10px;
        overflow: hidden;
    }
    .card {
        border-radius: 10px;
    }
    .table-active {
        background-color: rgba(40, 167, 69, 0.2);
    }
</style>

{% endblock %}