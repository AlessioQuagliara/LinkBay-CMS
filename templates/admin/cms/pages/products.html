{% extends "/admin/cms/interface/render.html" %}

{% block content %}
<div class="container my-4" data-aos="fade-up">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/toolbar.css') }}">

    <!-- Card per le funzioni della tabella -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div class="d-flex gap-3">
                <a href="/admin/cms/pages/products" class="btn {% if title == 'Products' %}btn-dark{% else %}btn-outline-dark{% endif %} btn-sm text-decoration-none ">
                    <i class="fa-solid fa-box"></i> Products
                </a>
                <a href="/admin/cms/pages/collections" class="btn btn-outline-dark btn-sm text-decoration-none">
                    <i class="fa-solid fa-layer-group"></i> Collections
                </a>
            </div>

            <div class="custom-toolbar">
                <button class="custom-btn" id="search-toggle-btn" title="Search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="search-input" class="custom-input d-none" placeholder="Search..." style="max-width: 200px;">
                </button>
                <button class="custom-btn" title="Add Product" id="add-product-btn">
                    <i class="fa-solid fa-plus"></i>
                </button>
                <button class="custom-btn" title="Copy Selected" id="copy-selected-btn">
                    <i class="fa-solid fa-copy"></i>
                </button>
                <button class="custom-btn select-all" title="Select All">
                    <i class="fa-solid fa-check"></i>
                </button>
                <button class="custom-btn delete-selected" title="Delete">
                    <i class="fa-solid fa-trash"></i>
                </button>
                <button class="custom-btn" title="Export" id="export-products-btn">
                    <i class="fa-solid fa-file-excel"></i>
                </button>
                <button class="custom-btn" data-bs-toggle="modal" data-bs-target="#customizationModal" id="customize-columns" title="Customize Columns">
                    <i class="fa-solid fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Paginazione minimalista e nera -->
        {% if pagination.pages > 1 %}
        <div class="card-footer bg-dark text-center py-2">
            <nav aria-label="Product pagination">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <!-- ðŸ”™ Indietro -->
                    {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link text-white bg-secondary border-0" href="{{ url_for('products.products', page=pagination.prev_num) }}">
                                <i class="fa-solid fa-angle-left"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link text-muted bg-secondary border-0"><i class="fa-solid fa-angle-left"></i></span>
                        </li>
                    {% endif %}

                    <!-- ðŸ”¢ Numeri delle pagine -->
                    {% for num in pagination.iter_pages() %}
                        {% if num %}
                            {% if num == pagination.page %}
                                <li class="page-item active">
                                    <span class="page-link bg-light text-dark border-0">{{ num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link text-white bg-secondary border-0" href="{{ url_for('products.products', page=num) }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled"><span class="page-link text-muted bg-secondary border-0">â€¦</span></li>
                        {% endif %}
                    {% endfor %}

                    <!-- â© Avanti -->
                    {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link text-white bg-secondary border-0" href="{{ url_for('products.products', page=pagination.next_num) }}">
                                <i class="fa-solid fa-angle-right"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link text-muted bg-secondary border-0"><i class="fa-solid fa-angle-right"></i></span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    <!-- Card per la tabella dei prodotti -->
        <div class="table-responsive" data-aos="fade-up">
                <table class="table table-hover table-bordered align-middle text-center" style="border-radius: 10px;">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col"><input type="checkbox" id="select-all-checkbox"></th>
                            <th scope="col" class="id">#</th>
                            <th scope="col" class="name">Name</th>
                            <th scope="col" class="description">Description</th>
                            <th scope="col" class="short_description">Short Description</th>
                            <th scope="col" class="price">Price</th>
                            <th scope="col" class="discount_price">Discount Price</th>
                            <th scope="col" class="stock_quantity">Stock</th>
                            <th scope="col" class="sku">SKU</th>
                            <th scope="col" class="category">Category</th>
                            <th scope="col" class="brand">Brand</th>
                            <th scope="col" class="weight">Weight</th>
                            <th scope="col" class="dimensions">Dimensions</th>
                            <th scope="col" class="color">Color</th>
                            <th scope="col" class="material">Material</th>
                            <th scope="col" class="image_url">Image URL</th>
                            <th scope="col" class="slug">Slug</th>
                            <th scope="col" class="is_active">Is Active</th>
                            <th scope="col" class="created_at">Created At</th>
                            <th scope="col" class="updated_at">Updated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr class="table-row" data-product-id="{{ product.id }}">
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td class="id">{{ product.id }}</td>
                            <td class="name">{{ product.name }}</td>
                            <td class="description">{{ product.description | safe }}</td>
                            <td class="short_description">{{ product.short_description }}</td>
                            <td class="price">â‚¬{{ product.price }}</td>
                            <td class="discount_price">â‚¬{{ product.discount_price }}</td>
                            <td class="stock_quantity">{{ product.stock_quantity }}</td>
                            <td class="sku">{{ product.sku }}</td>
                            <td class="category">{{ product.category_name or 'No Category' }}</td>
                            <td class="brand">{{ product.brand_id }}</td>
                            <td class="weight">{{ product.weight }}</td>
                            <td class="dimensions">{{ product.dimensions }}</td>
                            <td class="color">{{ product.color }}</td>
                            <td class="material">{{ product.material }}</td>
                            <td class="image_url">
                                <img src="{{ product.image_url }}" alt="{{ product.name }} Image" style="max-width: 50px; max-height: 50px;">
                            </td>
                            <td class="slug">{{ product.slug }}</td>
                            <td class="is_active">
                                <span class="badge {{ 'bg-success' if product.is_active else 'bg-danger' }}">
                                    {{ 'Active' if product.is_active else 'Inactive' }}
                                </span>
                            </td>
                            <td class="created_at">{{ product.created_at }}</td>
                            <td class="updated_at">{{ product.updated_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

<!-- Modal di configurazione -->
<div class="modal fade" id="customizationModal" tabindex="-1" aria-labelledby="customizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customizationModalLabel">Customize Table View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Drag & Drop to Reorder Columns</h6>
                <div id="sortable-columns" class="list-group">
                    <!-- Opzioni delle colonne generate dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // GESTIONE DELLE COLONNE PER PRODUCTS
    document.addEventListener('DOMContentLoaded', function () {
    const columnsContainer = document.getElementById('sortable-columns');
    const tablePreferencesKey = 'productsTablePreferences'; // Chiave univoca per localStorage

    const columns = [
        { value: 'id', label: '#' },
        { value: 'name', label: 'Name' },
        { value: 'description', label: 'Description' },
        { value: 'short_description', label: 'Short Description' },
        { value: 'price', label: 'Price' },
        { value: 'discount_price', label: 'Discount Price' },
        { value: 'stock_quantity', label: 'Stock' },
        { value: 'sku', label: 'SKU' },
        { value: 'category', label: 'Category' },
        { value: 'brand', label: 'Brand' },
        { value: 'weight', label: 'Weight' },
        { value: 'dimensions', label: 'Dimensions' },
        { value: 'color', label: 'Color' },
        { value: 'material', label: 'Material' },
        { value: 'image_url', label: 'Image URL' },
        { value: 'slug', label: 'Slug' },
        { value: 'is_active', label: 'Is Active' },
        { value: 'created_at', label: 'Created At' },
        { value: 'updated_at', label: 'Updated At' }
    ];

    function renderColumnOptions(preferences) {
        columnsContainer.innerHTML = '';

        // Usa l'ordine salvato nelle preferenze, altrimenti l'ordine di default
        const orderedColumns = preferences.order || columns.map(col => col.value);

        orderedColumns.forEach(columnValue => {
            const column = columns.find(col => col.value === columnValue);
            if (!column) return; // Skip se la colonna non esiste

            const isChecked = preferences[column.value] ?? true;
            const columnItem = document.createElement('div');
            columnItem.classList.add('list-group-item', 'd-flex', 'align-items-center');
            columnItem.dataset.column = column.value;
            columnItem.innerHTML = `
                <i class="fa-solid fa-grip-lines me-2"></i>
                <input class="form-check-input column-toggle me-2" type="checkbox" value="${column.value}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label flex-grow-1">${column.label}</label>
            `;
            columnsContainer.appendChild(columnItem);
        });

        // Aggiunge il listener per aggiornare la vista automaticamente
        document.querySelectorAll('.column-toggle').forEach(toggle => {
            toggle.addEventListener('change', function () {
                savePreferences();
                applyPreferences(loadPreferences());
            });
        });

        // Rendi il contenitore delle colonne ordinabile
        new Sortable(columnsContainer, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function () {
                savePreferences(); // Salva il nuovo ordine
                applyPreferences(loadPreferences());
            }
        });
    }

    function savePreferences() {
        const preferences = { order: [] };
        document.querySelectorAll('#sortable-columns .list-group-item').forEach(item => {
            const columnValue = item.dataset.column;
            const checkbox = item.querySelector('.column-toggle');
            preferences[columnValue] = checkbox.checked;
            preferences.order.push(columnValue);
        });
        localStorage.setItem(tablePreferencesKey, JSON.stringify(preferences));
    }

    function loadPreferences() {
        return JSON.parse(localStorage.getItem(tablePreferencesKey)) || {};
    }

    function applyPreferences(preferences) {
        const orderedColumns = preferences.order || columns.map(col => col.value);

        // Riordina le colonne nella tabella
        const tableHeadRow = document.querySelector('thead tr');
        const tableBodyRows = document.querySelectorAll('tbody tr');

        orderedColumns.forEach(columnValue => {
            const header = tableHeadRow.querySelector(`th.${columnValue}`);
            if (header) tableHeadRow.appendChild(header);

            tableBodyRows.forEach(row => {
                const cell = row.querySelector(`td.${columnValue}`);
                if (cell) row.appendChild(cell);
            });
        });

        // Nasconde/mostra le colonne in base alle preferenze
        columns.forEach(column => {
            const isChecked = preferences[column.value] ?? true;
            const header = document.querySelector(`thead th.${column.value}`);
            if (header) {
                header.style.display = isChecked ? '' : 'none';
            }
            document.querySelectorAll(`tbody td.${column.value}`).forEach(cell => {
                cell.style.display = isChecked ? '' : 'none';
            });
        });
    }

    // Inizializzazione
    const savedPreferences = loadPreferences();
    renderColumnOptions(savedPreferences);
    applyPreferences(savedPreferences);
});
</script>

<script>
    // SELEZIONE E MULTI-SELEZIONE DELLE RIGHE
    document.addEventListener('DOMContentLoaded', function () {
        const tableRows = document.querySelectorAll('.table-row');
        let isMouseDown = false;

        tableRows.forEach(row => {
            row.addEventListener('mousedown', function(event) {
                isMouseDown = true;
                toggleRowSelection(this);
                event.preventDefault();
            });

            row.addEventListener('mouseover', function() {
                if (isMouseDown) {
                    toggleRowSelection(this);
                }
            });
        });

        document.addEventListener('mouseup', function() {
            isMouseDown = false;
        });

        function toggleRowSelection(row) {
            const checkbox = row.querySelector('.row-checkbox');
            checkbox.checked = !checkbox.checked;
            row.classList.toggle('table-active', checkbox.checked);
        }

        document.querySelector('.select-all').addEventListener('click', function() {
            const allChecked = Array.from(tableRows).every(row => row.querySelector('.row-checkbox').checked);
            tableRows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                checkbox.checked = !allChecked;
                row.classList.toggle('table-active', checkbox.checked);
            });
        });

        document.getElementById('select-all-checkbox').addEventListener('change', function() {
            const isChecked = this.checked;
            tableRows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                checkbox.checked = isChecked;
                row.classList.toggle('table-active', isChecked);
            });
        });
    });
</script>

<script>
    // Doppio click sulla riga per andare alla pagina di modifica
    document.addEventListener('DOMContentLoaded', function () {
        const tableRows = document.querySelectorAll('.table-row');
        tableRows.forEach(row => {
            row.addEventListener('dblclick', function () {
                const productId = row.getAttribute('data-product-id');
                if (productId) {
                    window.location.href = `/admin/cms/pages/product/${productId}`;
                }
            });
        });
    });
</script>

<script>
    // Gestione della barra di ricerca
    document.addEventListener('DOMContentLoaded', function () {
        const searchToggleBtn = document.getElementById('search-toggle-btn');
        const searchInput = document.getElementById('search-input');
        const tableRows = document.querySelectorAll('.table-row');

        // Mostra/nasconde la barra di ricerca
        searchToggleBtn.addEventListener('click', function () {
            searchInput.classList.toggle('d-none');
            searchInput.focus();
        });

        // Filtro in tempo reale
        searchInput.addEventListener('input', function () {
            const searchText = searchInput.value.toLowerCase();
            tableRows.forEach(row => {
                const productName = row.querySelector('.name').textContent.toLowerCase();
                row.style.display = productName.includes(searchText) ? '' : 'none';
            });
        });
    });
</script>
<script>
    // GESTIONE DEL PULSANTE COPIA SELEZIONATI
    document.addEventListener('DOMContentLoaded', function () {
    const copySelectedButton = document.getElementById('copy-selected-btn');

    copySelectedButton.addEventListener('click', function () {
        const selectedRows = document.querySelectorAll('.row-checkbox:checked');
        if (selectedRows.length === 0) {
            Swal.fire('No Selection', 'Please select at least one product to copy.', 'warning');
            return;
        }

        // Recupera gli ID dei prodotti selezionati
        const productIds = Array.from(selectedRows).map(row =>
            row.closest('.table-row').getAttribute('data-product-id')
        );

        // Invia gli ID al server per salvarli nella sessione Flask
        fetch('/api/set_copied_products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_ids: productIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire('Copied!', `${productIds.length} products have been copied.`, 'success');
            } else {
                Swal.fire('Error', 'Failed to copy products.', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving copied products:', error);
            Swal.fire('Error', 'A network error occurred.', 'error');
        });
    });
});
</script>
<script>
    // CREAZIONE RIGA PRODOTTO
    document.getElementById('add-product-btn').addEventListener('click', function () {
        Swal.fire({
            title: 'Creating Product...',
            text: 'Please wait while the new product is being created.',
            icon: 'info',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        fetch('/api/create_product', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        })
        .then(response => response.json())
        .then(data => {
            Swal.close();
            if (data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: data.message,
                    icon: 'success'
                }).then(() => {
                    // Redirect to the product editing page
                    window.location.href = `/admin/cms/pages/product/${data.product_id}`;
                });
            } else {
                Swal.fire('Error!', data.message, 'error');
            }
        })
        .catch(error => {
            Swal.fire('Error!', 'A network error occurred.', 'error');
            console.error('Error:', error);
        });
    });
</script>

<script>
    // CANCELLAZIONE PRODOTTO
    document.querySelector('.delete-selected').addEventListener('click', function () {
        const selectedRows = document.querySelectorAll('.row-checkbox:checked');
        if (selectedRows.length === 0) {
            Swal.fire('No Selection', 'Please select at least one product to delete.', 'warning');
            return;
        }

        const productIds = Array.from(selectedRows).map(row => 
            row.closest('.table-row').getAttribute('data-product-id')
        );

        Swal.fire({
            title: 'Are you sure?',
            text: "This action will permanently delete the selected products.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete them!'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Deleting...',
                    text: 'Please wait while the products are being deleted.',
                    icon: 'info',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => Swal.showLoading()
                });

                fetch('/api/delete_products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_ids: productIds })
                })
                .then(response => response.json())
                .then(data => {
                    Swal.close();
                    if (data.success) {
                        Swal.fire('Deleted!', data.message, 'success').then(() => {
                            // Rimuovi le righe corrispondenti dalla tabella
                            productIds.forEach(id => {
                                document.querySelector(`.table-row[data-product-id="${id}"]`).remove();
                            });
                        });
                    } else {
                        Swal.fire('Error!', data.message || 'Failed to delete products.', 'error');
                    }
                })
                .catch(error => {
                    Swal.fire('Error!', 'A network error occurred.', 'error');
                    console.error('Error:', error);
                });
            }
        });
    });
</script>

<script>
    // ESPORTA IN CSV I PRODOTTI
    document.getElementById('export-products-btn').addEventListener('click', function () {
        Swal.fire({
            title: 'Exporting...',
            text: 'Please wait while the data is being exported.',
            icon: 'info',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        // Reindirizza alla rotta di esportazione
        window.location.href = '/admin/cms/export_products';
    });
</script>
<style>
    .table-row:hover {
        background-color: rgba(255, 14, 14, 0.1);
        transition: background-color 0.2s ease-in-out;
    }
    .table-bordered {
        border-radius: 10px;
        overflow: hidden;
    }
    .card {
        border-radius: 10px;
    }
    .table-active {
        background-color: rgba(40, 167, 69, 0.2);
    }
    .form-check-input:checked {
        background-color: #db3545 !important;
        border-color: #db3545 !important;
    }
    .fixed-on-bottom {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1050;
        background: #f8f9fa;
        box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.1);
    }
    .fixed-on-bottom .btn {
        border-radius: 50px;
        transition: all 0.2s ease-in-out;
    }
    .fixed-on-bottom .btn:hover {
        background-color: #343a40;
        color: white;
    }
    .fixed-on-bottom i {
        margin-right: 8px;
    }
    #search-input {
        transition: all 1s ease;
    }
</style>

{% endblock %}