{% extends "/admin/cms/interface/render.html" %}

{% block content %}

<!-- Tabella interattiva prodotti -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fa-solid fa-box"></i> Prodotti</h5>
        <div class="d-flex gap-2 flex-wrap">
            <a href="/admin/cms/products/create" class="btn btn-dark shadow-sm">
                <i class="fa-solid fa-plus text-white"></i> <span class="text-white">Nuovo</span>
            </a>
            <a href="/admin/cms/products/create" class="btn btn-dark shadow-sm">
                <i class="fa-solid fa-file-csv"></i> <span class="text-white">Importa</span>
            </a>
            <a href="" class="btn btn-dark shadow-sm clipboard">
                <i class="fa-solid fa-copy text-white"></i> <span class="text-white">Duplica</span>
            </a>
            <a href="" class="btn btn-dark shadow-sm trash">
                <i class="fa-solid fa-trash text-white"></i> <span class="text-white">Elimina</span>
            </a>
        </div>
    </div>
    <div class="card-body table-responsive">
        <table class="table table-hover align-middle" id="products-table">
            <thead>
                <tr>
                    <th scope="col"><input type="checkbox" id="select-all"></th>
                    <th scope="col" hidden>ID</th>
                    <th scope="col" hidden>Negozio</th>
                    <th scope="col">Nome</th>
                    <th scope="col" hidden>Descrizione</th>
                    <th scope="col">Descrizione breve</th>
                    <th scope="col">Prezzo</th>
                    <th scope="col">Prezzo scontato</th>
                    <th scope="col">Quantità in stock</th>
                    <th scope="col" hidden>Slug</th>
                    <th scope="col">Stato</th>
                    <th scope="col" hidden>Creato il</th>
                    <th scope="col" hidden>Aggiornato il</th>
                    <th scope="col">Categoria</th>
                    <th scope="col">Tipo</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products.items %}
                <tr data-id="{{ product.id }}" class="clickable-row">
                    <td><input type="checkbox" class="row-checkbox"></td>
                    <td hidden>{{ product.id }}</td>
                    <td hidden>{{ product.shop_id }}</td>
                    <td>{{ product.name }}</td>
                    <td hidden>{{ product.description }}</td>
                    <td>{{ product.short_description }}</td>
                    <td>€{{ "{:.2f}".format(product.price) }}</td>
                    <td>€{{ "{:.2f}".format(product.discount_price) if product.discount_price else "—" }}</td>
                    <td>{{ product.stock_quantity }}</td>
                    <td hidden>{{ product.slug }}</td>
                    <td>
                        {% if product.is_active %}
                            <span class="badge bg-success">Attivo</span>
                        {% else %}
                            <span class="badge bg-secondary">Inattivo</span>
                        {% endif %}
                    </td>
                    <td hidden>{{ product.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td hidden>{{ product.updated_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>{{ product.category_id if product.category_id else "—" }}</td>
                    <td>
                        {% if product.is_digital %}
                            <i class="fa-solid fa-download text-dark" title="Digitale"></i> Digitale
                        {% else %}
                            <i class="fa-solid fa-box text-dark" title="Fisico"></i> Fisico
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <small class="text-black">Doppio click sulla riga per modificare</small>

    </div>
</div>

<nav aria-label="Navigazione pagine">
  <ul class="pagination justify-content-center mt-4">
    {% if products.has_prev %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('products.render_products_table', page=products.prev_num) }}">&laquo;</a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">&laquo;</span>
    </li>
    {% endif %}

    {% for p in range(1, products.pages + 1) %}
    <li class="page-item {% if p == products.page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('products.render_products_table', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}

    {% if products.has_next %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('products.render_products_table', page=products.next_num) }}">&raquo;</a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">&raquo;</span>
    </li>
    {% endif %}
  </ul>
</nav>

<style>
    #products-table th, #products-table td {
        vertical-align: middle;
    }

    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .clickable-row:hover {
        background-color: #f1f1f1;
    }

    .clickable-row.selected {
        background-color: #d1e7dd !important;
    }

    .btn i {
        margin-right: 4px;
    }

    /* Checkbox accent color when checked */
    input[type="checkbox"]:checked {
        accent-color: #ff5758;
    }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      let clickTimer = null;

      function getSelectedProductIds() {
          return JSON.parse(sessionStorage.getItem("selectedProducts") || "[]");
      }

      function setSelectedProductIds(ids) {
          sessionStorage.setItem("selectedProducts", JSON.stringify(ids));
      }

      function toggleProductIdInSession(id, isSelected) {
          let current = getSelectedProductIds();
          if (isSelected) {
              if (!current.includes(id)) current.push(id);
          } else {
              current = current.filter(x => x != id);
          }
          setSelectedProductIds(current);
      }

      document.querySelectorAll("#products-table tbody tr").forEach(function(row) {
          const checkbox = row.querySelector(".row-checkbox");
          const productId = row.dataset.id;

          row.addEventListener("click", function (e) {
              if (!e.target.closest("input, a, button, i")) {
                  if (clickTimer === null) {
                      clickTimer = setTimeout(() => {
                          checkbox.checked = !checkbox.checked;
                          row.classList.toggle("selected", checkbox.checked);
                          toggleProductIdInSession(productId, checkbox.checked);
                          clickTimer = null;
                      }, 250);
                  } else {
                      clearTimeout(clickTimer);
                      clickTimer = null;
                      window.location.href = `/admin/cms/products/edit/${productId}`;
                  }
              }
          });

          checkbox.addEventListener("change", function () {
              row.classList.toggle("selected", checkbox.checked);
              toggleProductIdInSession(productId, checkbox.checked);
          });
      });

      const selectAllCheckbox = document.getElementById("select-all");
      if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener("change", function () {
              const isChecked = this.checked;
              document.querySelectorAll(".row-checkbox").forEach(function (checkbox) {
                  const row = checkbox.closest("tr");
                  const productId = row.dataset.id;
                  checkbox.checked = isChecked;
                  row.classList.toggle("selected", isChecked);
                  toggleProductIdInSession(productId, isChecked);
              });
          });
      }

      document.querySelector('a[href=""][class*="clipboard"]').addEventListener("click", function (e) {
          e.preventDefault();
          const selectedIds = getSelectedProductIds();
          if (selectedIds.length === 0) {
              Swal.fire("Attenzione", "Seleziona almeno un prodotto da duplicare.", "warning");
              return;
          }
          fetch("/api/copy_products", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "X-Requested-With": "XMLHttpRequest"
              },
              body: JSON.stringify({ product_ids: selectedIds })
          })
          .then(res => res.json())
          .then(data => {
              if (data.status === "success") {
                  Swal.fire("Successo", "Prodotti duplicati correttamente.", "success");
                    setTimeout(() => {
                        window.location.href = "/admin/cms/pages/products";
                    }, 1500);
              } else {
                  Swal.fire("Errore", "Errore nella duplicazione.", "error");
              }
          });
      });

      document.querySelector('a[href=""][class*="trash"]').addEventListener("click", function (e) {
          e.preventDefault();
          const selectedIds = getSelectedProductIds();
          if (selectedIds.length === 0) {
              Swal.fire("Attenzione", "Seleziona almeno un prodotto da eliminare.", "warning");
              return;
          }
          Swal.fire({
              title: "Sei sicuro?",
              text: "Questa azione eliminerà i prodotti selezionati.",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#d33",
              cancelButtonColor: "#3085d6",
              confirmButtonText: "Sì, elimina"
          }).then((result) => {
              if (result.isConfirmed) {
                  fetch("/api/delete_products", {
                      method: "POST",
                      headers: {
                          "Content-Type": "application/json",
                          "X-Requested-With": "XMLHttpRequest"
                      },
                      body: JSON.stringify({ product_ids: selectedIds })
                  })
                  .then(res => res.json())
                  .then(data => {
                      if (data.status === "success") {
                          Swal.fire("Eliminati!", "I prodotti sono stati eliminati.", "success").then(() => {
                              setTimeout(() => {
                                  window.location.href = "/admin/cms/pages/products";
                                }, 1500);
                          });
                      } else {
                          Swal.fire("Errore", "Errore nell'eliminazione.", "error");
                      }
                  });
              }
          });
      });
  });
</script>

{% endblock %}