<% /* Usage: include near products list. If clientSideProducts array is passed, filtering happens client-side. */ %>
<div x-data="productFilters(<%- JSON.stringify(typeof clientSideProducts !== 'undefined' ? clientSideProducts : []) %>)" class="mb-4 flex space-x-2">
  <input x-model="q" placeholder="Cerca..." class="px-3 py-2 border rounded w-1/3" />
  <select x-model="category" class="px-3 py-2 border rounded">
    <option value="">Tutte le categorie</option>
    <option value="featured">Featured</option>
  </select>
  <button @click="apply()" class="px-3 py-2 rounded bg-primary text-white">Applica</button>

  <script>
    function productFilters(initial){
      return {
        q: '', category: '', items: initial || [],
        apply(){
          if(this.items && this.items.length){
            // client-side filter
            const filtered = this.items.filter(i => (!this.q || i.title.toLowerCase().includes(this.q.toLowerCase())) && (!this.category || (i.tags && i.tags.includes(this.category))));
            // render client-side: emit event with filtered items
            window.dispatchEvent(new CustomEvent('products:filtered', { detail: filtered }));
          } else {
            // server-side filter via HTMX
            const params = new URLSearchParams(); if(this.q) params.set('q', this.q); if(this.category) params.set('category', this.category);
            htmx.ajax('GET', '/api/products?partial=table&' + params.toString(), { target: '#products-table', swap: 'innerHTML' });
          }
        }
      }
    }
  </script>
</div>
