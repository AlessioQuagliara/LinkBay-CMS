{% extends 'landing/base.html' %}
{% block content %}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
  <div class="d-flex align-items-center">
    <i class="fas fa-comments fa-2x text-danger me-3"></i>
    <div>
      <h3 class="mb-0">Le tue Chat</h3>
      <p class="text-muted mb-0">Comunica con gli altri membri della piattaforma</p>
    </div>
  </div>
  <a href="/dashboard" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
  </a>
</div>

<!-- DIVISORE -->
<div class="border-top border-danger border-2 my-4 opacity-75"></div>

<!-- BARRA RICERCA CHAT -->
<div class="input-group mb-3">
  <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
  <input id="chatSearch" type="text" class="form-control" placeholder="Cerca utenti…">
</div>

<!-- LISTA CHAT -->
<div class="card shadow-sm border-0" data-aos="fade-up">
  <div class="card-body p-0">
    <ul id="chatList" class="list-group list-group-flush">
      {% for u in chat_users %}
      <a href="{{ url_for('landing.dashboard_private_chat', target_user_id=u.id) }}" class="list-group-item list-group-item-action d-flex align-items-center py-3 chat-item">
        <img src="{{ u.profilo_foto or '/static/images/superadmin/user_extend.png' }}" alt="avatar" class="rounded-circle me-3" width="48" height="48" style="object-fit:cover;">
        <div class="flex-grow-1">
          <div class="fw-bold">{{ u.nome }} {{ u.cognome }}</div>
          <small class="text-muted">Clicca per aprire la chat</small>
        </div>
        {% if u.unread_count > 0 %}
          <span class="badge bg-danger me-2">{{ u.unread_count }}</span>
        {% endif %}
        <i class="fas fa-chevron-right text-muted"></i>
      </a>
      {% else %}
      <li class="list-group-item text-center text-muted py-4">Nessuna chat disponibile</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- PULSANTE AIUTO -->
<button id="start-chat-tutorial" class="btn btn-danger position-fixed bottom-0 end-0 m-4 rounded-circle shadow"
        style="width:50px; height:50px;">
  <i class="fas fa-question"></i>
</button>

{% endblock %}

<style>
  .chat-item:hover {
    background: rgba(220,53,69,.05);
    text-decoration: none;
  }
</style>

<script>
/* 🔍 Ricerca live tra le chat */
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('chatSearch');
  const items = () => document.querySelectorAll('#chatList .chat-item');

  input.addEventListener('input', () => {
    const term = input.value.toLowerCase();
    items().forEach(el => {
      el.style.display = el.innerText.toLowerCase().includes(term) ? '' : 'none';
    });
  });

  /* Shepherd tour */
  if (typeof Shepherd !== 'undefined') {
    const tour = new Shepherd.Tour({
      defaultStepOptions:{
        cancelIcon:{enabled:true},
        scrollTo:{behavior:'smooth',block:'center'},
        classes:'shadow-lg bg-danger text-white',
        arrow:true
      },
      useModalOverlay:true
    });

    tour.addStep({
      title:'<i class="fas fa-search"></i>&nbsp; Cerca Utente',
      text:'Filtra rapidamente la lista digitando qui.',
      attachTo:{element:'#chatSearch',on:'bottom'},
      buttons:[{text:'Avanti',action:tour.next}]
    });

    tour.addStep({
      title:'<i class="fas fa-comments"></i>&nbsp; Apri Chat',
      text:'Clicca su un utente per iniziare a chattare.',
      attachTo:{element:'#chatList',on:'top'},
      buttons:[
        {text:'Indietro',action:tour.back},
        {text:'Fatto!',action:tour.complete}
      ]
    });

    document.getElementById('start-chat-tutorial')
            .addEventListener('click',()=>tour.start());
  }
});
</script>