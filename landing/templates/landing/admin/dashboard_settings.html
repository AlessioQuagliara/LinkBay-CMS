{% extends 'landing/base.html' %}
{% block content %}

<!-- HEADER UNIFORME -->
<div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
  <div class="d-flex align-items-center">
    <i class="fas fa-user-cog fa-2x text-danger me-3"></i>
    <div>
      <h3 class="mb-0">Modifica Profilo</h3>
      <p class="text-muted mb-0">Aggiorna le tue informazioni personali</p>
    </div>
  </div>
  <a href="/dashboard" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
  </a>
</div>

<!-- DIVISORE -->
<div class="border-top border-danger border-2 my-4 opacity-75"></div>

<!-- CARD PRINCIPALE -->
<div class="card shadow-sm border-0 rounded-4" data-aos="fade-up">
  <div class="card-body">
    <form id="updateProfileForm" class="row g-3" enctype="multipart/form-data">
      
      <!-- AVATAR UPLOAD -->
      <div class="col-12 text-center mb-4">
        <div class="avatar-upload-wrapper position-relative mx-auto" 
             style="width: 120px; height: 120px; cursor: pointer;"
             title="Clicca o trascina un'immagine">
          <label for="avatarUpload" class="avatar-placeholder rounded-circle d-flex justify-content-center align-items-center" 
                 style="width: 100%; height: 100%; border: 2px dashed #dc3545; transition: all 0.3s ease;">
            <i class="fas fa-camera text-danger fa-2x"></i>
          </label>
          <input type="file" name="avatar" id="avatarUpload" class="d-none" accept="image/*">
          {% if user.profilo_foto %}
            <img id="avatarPreview" class="rounded-circle position-absolute top-0 start-0 w-100 h-100 object-fit-cover border border-2 border-danger" 
                 src="{{ user.profilo_foto }}" alt="Avatar" style="display: block;">
          {% else %}
            <img id="avatarPreview" class="rounded-circle position-absolute top-0 start-0 w-100 h-100 object-fit-cover border border-2 border-danger" 
                 src="/static/images/users/default_avatar.png" alt="Avatar" style="display: none;">
          {% endif %}
        </div>
        <small class="text-muted">Clicca per cambiare la tua foto profilo</small>
      </div>

      <!-- CAMPI FORM -->
      <div class="col-md-6">
        <label for="nome" class="form-label">Nome</label>
        <input type="text" class="form-control" id="nome" name="nome" value="{{ user.nome }}" required>
      </div>

      <div class="col-md-6">
        <label for="cognome" class="form-label">Cognome</label>
        <input type="text" class="form-control" id="cognome" name="cognome" value="{{ user.cognome }}" required>
      </div>

      <div class="col-md-6">
        <label for="telefono" class="form-label">Telefono</label>
        <input type="text" class="form-control" id="telefono" name="telefono" value="{{ user.telefono }}">
      </div>

      <div class="col-md-6">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" disabled>
      </div>

      <!-- BOTTONE SALVA -->
      <div class="col-12 text-center mt-3">
        <button type="submit" class="btn btn-danger px-4 py-2">
          <i class="fas fa-save me-2"></i> Salva Modifiche
        </button>
      </div>
    </form>
  </div>
</div>

<!-- PULSANTE AIUTO -->
<button id="start-tutorial" class="btn btn-danger position-fixed bottom-0 end-0 m-4 rounded-circle shadow" 
        style="width: 50px; height: 50px;">
  <i class="fas fa-question"></i>
</button>

{% endblock %}

{% block scripts %}
<script>
// Gestione upload avatar
const avatarUpload = document.getElementById('avatarUpload');
const avatarPreview = document.getElementById('avatarPreview');
const avatarWrapper = document.querySelector('.avatar-upload-wrapper');

// Click per upload
avatarUpload.addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      avatarPreview.src = e.target.result;
      avatarPreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

// Drag & Drop
avatarWrapper.addEventListener('dragover', (e) => {
  e.preventDefault();
  avatarWrapper.style.borderColor = '#ff5757';
  avatarWrapper.style.borderStyle = 'solid';
});

avatarWrapper.addEventListener('dragleave', () => {
  avatarWrapper.style.borderColor = '#dc3545';
  avatarWrapper.style.borderStyle = 'dashed';
});

avatarWrapper.addEventListener('drop', (e) => {
  e.preventDefault();
  avatarWrapper.style.borderColor = '#dc3545';
  avatarWrapper.style.borderStyle = 'dashed';
  
  const file = e.dataTransfer.files[0];
  if (file && file.type.match('image.*')) {
    avatarUpload.files = e.dataTransfer.files;
    const reader = new FileReader();
    reader.onload = e => {
      avatarPreview.src = e.target.result;
      avatarPreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

// Invio form
document.getElementById('updateProfileForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);

  fetch('/api/update_profile', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Profilo aggiornato!',
        text: 'Le tue modifiche sono state salvate con successo.',
        confirmButtonColor: '#dc3545'
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Errore',
        text: data.message || 'Si Ã¨ verificato un errore durante il salvataggio',
        confirmButtonColor: '#dc3545'
      });
    }
  })
  .catch(err => {
    Swal.fire({
      icon: 'error',
      title: 'Errore di connessione',
      text: 'Impossibile connettersi al server',
      confirmButtonColor: '#dc3545'
    });
  });
});

// Tour guidato
document.getElementById('start-tutorial').addEventListener('click', () => {
  const tour = new Shepherd.Tour({
    defaultStepOptions: {
      cancelIcon: { enabled: true },
      scrollTo: { behavior: 'smooth', block: 'center' },
      classes: 'shadow-lg bg-danger text-white',
      arrow: true
    },
    useModalOverlay: true
  });

  tour.addStep({
    title: '<i class="fas fa-camera"></i> Foto Profilo',
    text: 'Clicca qui per cambiare la tua immagine del profilo. Puoi anche trascinare un\'immagine.',
    attachTo: {
      element: '.avatar-upload-wrapper',
      on: 'bottom'
    },
    buttons: [
      { text: 'Salta', action: tour.cancel },
      { text: 'Avanti', action: tour.next }
    ]
  });

  tour.addStep({
    title: '<i class="fas fa-user"></i> Dati Personali',
    text: 'Aggiorna qui il tuo nome e cognome. Questi dati saranno visibili ai colleghi.',
    attachTo: {
      element: '#nome',
      on: 'bottom'
    },
    buttons: [
      { text: 'Indietro', action: tour.back },
      { text: 'Avanti', action: tour.next }
    ]
  });

  tour.addStep({
    title: '<i class="fas fa-save"></i> Salva Modifiche',
    text: 'Ricorda di salvare le modifiche apportate al tuo profilo.',
    attachTo: {
      element: '#updateProfileForm button[type="submit"]',
      on: 'top'
    },
    buttons: [
      { text: 'Fine', action: tour.complete }
    ]
  });

  tour.start();
});
</script>
{% endblock %}