{% extends 'landing/base.html' %}
{% block content %}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
  <div class="d-flex align-items-center">
    <i class="fas fa-credit-card fa-2x text-danger me-3"></i>
    <div>
      <h3 class="mb-0">Fatturazione & Pagamenti</h3>
      <p class="text-muted mb-0">Gestisci i tuoi pagamenti e scarica le fatture</p>
    </div>
  </div>
  <a href="/dashboard" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
  </a>
</div>

<!-- DIVISORE -->
<div class="border-top border-danger border-2 my-4 opacity-75"></div>

<!-- OVERVIEW CARDS -->
<div class="row g-4 mb-4" data-aos="fade-up">
  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100 text-center">
      <div class="card-body">
        <div class="bg-success bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width:60px;height:60px;">
          <i class="fas fa-arrow-down fa-2x text-success"></i>
        </div>
        <h5 class="card-title">Totale Accrediti</h5>
        <h3 class="text-success mb-0" id="total-received">€ –</h3>
        <small class="text-muted">Ricevuti da LinkBay</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100 text-center">
      <div class="card-body">
        <div class="bg-primary bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width:60px;height:60px;">
          <i class="fas fa-arrow-up fa-2x text-primary"></i>
        </div>
        <h5 class="card-title">Totale Pagato</h5>
        <h3 class="text-primary mb-0" id="total-sent">€ –</h3>
        <small class="text-muted">Versato a fornitori</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100 text-center">
      <div class="card-body">
        <div class="bg-warning bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width:60px;height:60px;">
          <i class="fas fa-file-invoice fa-2x text-warning"></i>
        </div>
        <h5 class="card-title">Fatture in Scadenza</h5>
        <h3 class="text-warning mb-0" id="upcoming-bills">–</h3>
        <small class="text-muted">Da pagare entro 30 gg</small>
      </div>
    </div>
  </div>
</div>

<!-- SEARCH BAR -->
<div class="input-group mb-3">
  <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
  <input id="paymentSearch" type="text" class="form-control" placeholder="Cerca pagamenti…">
</div>

<!-- LISTA PAGAMENTI -->
<div class="card border-0 shadow-sm" data-aos="fade-up">
  <div class="card-header bg-danger text-white">
    <h5 class="mb-0"><i class="fas fa-money-bill-wave me-1"></i> Pagamenti Effettuati</h5>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table id="sentTable" class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="min-width:120px;">Data</th>
            <th>Importo</th>
            <th>Metodo</th>
            <th>Fattura</th>
          </tr>
        </thead>
        <tbody id="sentTransactionsTable">
          <!-- Row template iniettate via JS -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- PULSANTE AIUTO -->
<button id="start-billing-tutorial" class="btn btn-danger position-fixed bottom-0 end-0 m-4 rounded-circle shadow"
        style="width:50px;height:50px;">
  <i class="fas fa-question"></i>
</button>

{% endblock %}

<style>
  /* Hover leggero sulle righe */
  #sentTable tbody tr:hover { background: rgba(220,53,69,.05); }
</style>

<script src="/static/js/superadmin/payments.js"></script>

<script>
/* Live search sulla tabella */
document.addEventListener('DOMContentLoaded', () => {
  const search = document.getElementById('paymentSearch');
  const rows   = () => document.querySelectorAll('#sentTable tbody tr');

  search.addEventListener('input', () => {
    const t = search.value.toLowerCase();
    rows().forEach(r => {
      r.style.display = r.innerText.toLowerCase().includes(t) ? '' : 'none';
    });
  });

  /* Shepherd tour */
  if (typeof Shepherd !== 'undefined') {
    const tour = new Shepherd.Tour({
      defaultStepOptions:{
        cancelIcon:{enabled:true},
        scrollTo:{behavior:'smooth',block:'center'},
        classes:'shadow-lg bg-danger text-white',
        arrow:true
      },
      useModalOverlay:true
    });

    tour.addStep({
      title:'<i class="fas fa-file-invoice"></i>&nbsp; Statistiche Pagamenti',
      text:'Panoramica dei tuoi accrediti, pagamenti e fatture imminenti.',
      attachTo:{element:'.row.g-4',on:'bottom'},
      buttons:[{text:'Avanti',action:tour.next}]
    });
    tour.addStep({
      title:'<i class="fas fa-search"></i>&nbsp; Filtra Pagamenti',
      text:'Digita qui per cercare rapidamente tra i pagamenti.',
      attachTo:{element:'#paymentSearch',on:'bottom'},
      buttons:[
        {text:'Indietro',action:tour.back},
        {text:'Fatto!',action:tour.complete}
      ]
    });

    document.getElementById('start-billing-tutorial')
            .addEventListener('click',()=>tour.start());
  }
});
</script>
