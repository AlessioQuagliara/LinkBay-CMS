{% extends 'landing/base.html' %}
{% block content %}

<!-- HEADER (coerente con le altre pagine) -->
<div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
  <div class="d-flex align-items-center">
    <i class="fas fa-comments fa-2x text-danger me-3"></i>
    <div>
      <h3 class="mb-0">Chat con {{ target_user.nome }} {{ target_user.cognome }}</h3>
      <p class="text-muted mb-0">Conversazione privata</p>
    </div>
  </div>
  <a href="/dashboard/chats" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Torna alle Chat
  </a>
</div>

<!-- DIVISORE -->
<div class="border-top border-danger border-2 my-4 opacity-75"></div>

<!-- CARD CHAT -->
<div class="card shadow-sm border-0 rounded-4" style="height:70vh;" data-aos="fade-up">

  <!-- HEADER INTERNO CON AVATAR -->
  <div class="card-header bg-danger text-white d-flex align-items-center rounded-top-4">
    <img src="{{ target_user.profilo_foto or '/static/images/superadmin/user_extend.png' }}"
         alt="avatar" class="rounded-circle me-2" width="36" height="36" style="object-fit:cover;">
    <strong>{{ target_user.nome }} {{ target_user.cognome }}</strong>
    <span class="ms-auto badge bg-light text-dark">Online</span>
  </div>

  <!-- MESSAGGI -->
  <div id="chat-messages"
       class="card-body p-4"
       style="overflow-y:auto; height:calc(100% - 130px);
              background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);">
    <div class="text-center text-muted mt-4">
      <i class="fas fa-comment-dots me-2"></i>Inizia la conversazione…
    </div>
  </div>

  <!-- FOOTER / INPUT -->
  <div class="card-footer bg-light rounded-bottom-4">
    <form id="chat-form" class="d-flex align-items-center gap-2">
      <input id="chat-input"
             type="text"
             class="form-control"
             placeholder="Scrivi un messaggio…"
             autocomplete="off">

      <!-- SELECT CON ICONE -->
      <select id="attachment-type" class="form-select" style="max-width:200px;">
        <option value="">&#xf0c1;  Nessun allegato</option>
        <option value="collab">&#xf0c0;  Collaborazione</option>
        <option value="shop_sale">&#xf54f;  Vendita Negozio</option>
        <option value="theme_sale">&#xf53f;  Vendita Tema</option>
      </select>

      <button type="submit" class="btn btn-danger rounded-circle" style="width:48px; height:48px;">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>

<!-- DATI PER JS -->
<div id="chat-container"
     data-receiver-id="{{ target_user.id }}"
     data-sender-id="{{ user.id }}">
</div>


<!-- SCRIPT ORIGINALE – NON MODIFICATO ----------------------------------->
<script>
  /* === codice JS rimasto invariato === */
  const chatForm  = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const chatBox   = document.getElementById("chat-messages");
  const chatData  = document.getElementById("chat-container");
  const receiverId = chatData.dataset.receiverId;
  const senderId   = chatData.dataset.senderId;

  async function loadMessages() {
    try {
      chatBox.innerHTML = "";
      await fetch(`/api/chat/mark-read`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sender_id: receiverId })
      });
      const response = await fetch(`/api/chat/messages?user_id=${receiverId}`);
      const data = await response.json();
      chatBox.innerHTML = "";
      data.data.forEach(msg => {
        const isSent = msg.sender_id == senderId;
        let contentHtml = '';

        if (msg.attachment_url) {
          if (msg.attachment_url === 'collab') {
            contentHtml = `<div class="bg-light border rounded p-2">
                             <strong><i class="fas fa-handshake me-1"></i>Proposta di collaborazione</strong><br>
                             <button class="btn btn-sm btn-outline-success mt-2">Accetta</button>
                           </div>`;
          } else if (msg.attachment_url === 'shop_sale') {
            contentHtml = `<div class="bg-light border rounded p-2">
                             <strong><i class="fas fa-store me-1"></i>Proposta di vendita negozio</strong><br>
                             <a href="/dashboard/store/${msg.shop_name}"
                                class="btn btn-sm btn-outline-primary mt-2">Vedi negozio</a>
                           </div>`;
          } else if (msg.attachment_url === 'theme_sale') {
            contentHtml = `<div class="bg-light border rounded p-2">
                             <strong><i class="fas fa-palette me-1"></i>Proposta di vendita tema</strong><br>
                             <a href="/dashboard/themes"
                                class="btn btn-sm btn-outline-warning mt-2">Scopri il tema</a>
                           </div>`;
          }
        }

        const readIcon = msg.is_read
          ? '<i class="fa fa-check-double text-success small ms-2"></i>'
          : '<i class="fa fa-check text-muted small ms-2"></i>';

        const msgDiv = document.createElement("div");
        msgDiv.classList.add("mb-3","d-flex",isSent?"justify-content-end":"justify-content-start");

        let baseMessage = `
          <div class="p-3 rounded ${isSent?'bg-danger text-white':'bg-light text-dark'} d-inline-block shadow-sm"
               style="max-width:70%;">
            <div>${msg.message}</div>
            <div class="mt-2 text-end">
              ${readIcon}
              <small class="text-muted ms-2">
                ${new Date(msg.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
              </small>
            </div>
          </div>`;

        msgDiv.innerHTML = baseMessage + (contentHtml ? `<div class="mt-2">${contentHtml}</div>` : '');
        chatBox.appendChild(msgDiv);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    } catch (err) { console.error("Errore caricamento messaggi:",err); }
  }

  chatForm.addEventListener("submit", async e => {
    e.preventDefault();
    const message    = chatInput.value.trim();
    const attachment = document.getElementById("attachment-type").value;
    if (message) {
      await fetch("/api/chat/send",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ receiver_id:receiverId, message, attachment_url:attachment })
      });
      chatInput.value = "";
      await loadMessages();
    }
  });

  setInterval(loadMessages,3000);
  loadMessages();
</script>
{% endblock %}

<style>
/* Icone nelle option */
#attachment-type,
#attachment-type option {
  font-family: "Font Awesome 6 Free", "Electrolize", sans-serif;
  font-weight: 400;
}

/* Bolle messaggi (senza toccare il JS) */
#chat-messages .bg-danger {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  border-radius: 18px !important;
}
#chat-messages .bg-light {
  border: 1px solid #dee2e6;
  border-radius: 18px !important;
}
#chat-messages .p-3 {
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
</style>

