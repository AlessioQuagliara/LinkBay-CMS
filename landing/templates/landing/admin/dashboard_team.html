{% extends 'landing/base.html' %}
{% block content %}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
  <div class="d-flex align-items-center">
    <i class="fas fa-store fa-2x text-danger me-3"></i>
    <div>
      <h3 class="mb-0">Community Store</h3>
      <p class="text-muted mb-0">Classifica e ricerca degli store su LinkBay-CMS</p>
    </div>
  </div>
  <a href="/dashboard" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
  </a>
</div>

<!-- DIVISORE -->
<div class="border-top border-danger border-2 my-4 opacity-75"></div>

<!-- TOP-STORE RANKING -->
{% if top_stores %}
<div class="row g-4 mb-4" data-aos="fade-up">
  {% for s in top_stores[:3] %}
  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100 rounded-4">
      <div class="card-body d-flex flex-column justify-content-between text-center">
        <div>
          <div class="bg-danger bg-opacity-10 rounded-circle mx-auto mb-3 d-flex justify-content-center align-items-center" style="width:70px; height:70px;">
            <i class="fas fa-crown fa-2x text-danger"></i>
          </div>
          <h5 class="mb-1">{{ s.shop_name }}</h5>
          <span class="badge bg-info">{{ s.shop_type }}</span>
        </div>
        <h4 class="fw-bold text-primary mt-3">
          € {{ '{:,.2f}'.format(s.total_revenue) }}
        </h4>
        <small class="text-muted">Fatturato totale</small>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- SEARCH BAR -->
<div class="input-group mb-3">
  <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
  <input id="storeSearch" type="text" class="form-control" placeholder="Cerca store…">
</div>

<!-- STORE TABLE -->
<div class="table-responsive" data-aos="fade-up">
  <table id="storeTable" class="table table-hover table-borderless align-middle bg-white rounded shadow-sm overflow-hidden">
    <thead class="table-danger text-dark">
      <tr>
        <th style="width:60px;">#</th>
        <th>Nome Store</th>
        <th>Tipo</th>
        <th>Dominio</th>
        <th>Proprietario</th>
      </tr>
    </thead>
    <tbody>
      {% for store in stores %}
      <tr>
        <td class="fw-bold">{{ loop.index }}</td>
        <td>{{ store.shop_name }}</td>
        <td><span class="badge bg-info">{{ store.shop_type }}</span></td>
        <td>
          {% if store.domain %}
            <a href="//{{ store.domain }}" target="_blank">{{ store.domain }}</a>
          {% else %}
            <span class="text-muted">N/D</span>
          {% endif %}
        </td>
        <td>
          <a href="{{ url_for('landing.dashboard_user_profile', user_id=store.owner_id) }}">
            {{ store.nome }} {{ store.cognome }}
          </a>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center py-4">
          <div class="alert alert-info mb-0">Nessuno store registrato al momento</div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- PAGINAZIONE -->
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    {% if page > 1 %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('landing.store_list', page=page-1) }}">« Precedente</a>
    </li>
    {% endif %}
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('landing.store_list', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
    {% if page < total_pages %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('landing.store_list', page=page+1) }}">Successivo »</a>
    </li>
    {% endif %}
  </ul>
</nav>

<!-- PULSANTE AIUTO -->
<button id="start-collab-tutorial" class="btn btn-danger position-fixed bottom-0 end-0 m-4 rounded-circle shadow"
        style="width:50px; height:50px;">
  <i class="fas fa-question"></i>
</button>

{% endblock %}

<style>
  /* Hover soft-lift sulle righe */
  #storeTable tbody tr:hover {
    background: rgba(220, 53, 69, 0.05);
    cursor: pointer;
  }
</style>

<script>
/* 🔍 Ricerca live nella tabella */
document.addEventListener('DOMContentLoaded', () => {
  const input  = document.getElementById('storeSearch');
  const rows   = Array.from(document.querySelectorAll('#storeTable tbody tr'));

  input.addEventListener('input', () => {
    const term = input.value.toLowerCase();
    rows.forEach(r => {
      r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none';
    });
  });

  /* Shepherd tour */
  if (typeof Shepherd !== 'undefined') {
    const tour = new Shepherd.Tour({
      defaultStepOptions: {
        cancelIcon:{enabled:true},
        scrollTo:{behavior:'smooth', block:'center'},
        classes:'shadow-lg bg-danger text-white',
        arrow:true
      },
      useModalOverlay:true
    });

    tour.addStep({
      title:'<i class="fas fa-crown"></i>&nbsp; Top Store',
      text:'Qui trovi i tre store con il fatturato migliore.',
      attachTo:{element:'.row.g-4', on:'bottom'},
      buttons:[{text:'Avanti',action:tour.next}]
    });

    tour.addStep({
      title:'<i class="fas fa-search"></i>&nbsp; Cerca Store',
      text:'Filtra rapidamente la lista digitando qui.',
      attachTo:{element:'#storeSearch', on:'bottom'},
      buttons:[
        {text:'Indietro',action:tour.back},
        {text:'Fatto!',action:tour.complete}
      ]
    });

    document.getElementById('start-collab-tutorial')
            .addEventListener('click',()=>tour.start());
  }
});
</script>
