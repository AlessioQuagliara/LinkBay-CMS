{% extends 'landing/base.html' %}
{% block content %}

    <!-- CONTENUTI DINAMICI -->
    <div id="content9" class="content-pane" data-aos="fade-up">
      
      <div class="container py-5">
        <div class="card shadow border-0">
          <div class="card-header bg-danger text-white text-center">
            <h4 class="mb-0">
              <i class="fa-solid fa-user-gear me-2"></i>Update Your Profile
            </h4>
          </div>
          <div class="card-body bg-white">
            <form id="updateProfileForm" class="row g-3" enctype="multipart/form-data">
      
              <!-- üîÑ Avatar Upload (Drag or Click) -->
              <div class="col-12 text-center">
                <div class="avatar-upload-wrapper position-relative mx-auto mb-3" style="width: 120px; height: 120px;">
                  <label for="avatarUpload" class="avatar-placeholder rounded-circle border border-2 border-danger d-flex justify-content-center align-items-center text-danger fw-bold" style="width: 120px; height: 120px; border: 2px dashed #dc3545; transition: border 0.3s ease; cursor: pointer;">
                    <i class="fa-solid fa-plus fa-2x"></i>
                  </label>
                  <input type="file" name="avatar" id="avatarUpload" class="d-none" accept="image/*">
                  {% if user.profilo_foto %}
                    <img id="avatarPreview" class="rounded-circle position-absolute top-0 start-0 w-100 h-100 object-fit-cover" src="{{ user.profilo_foto }}" alt="Profile" style="display: block;">
                  {% else %}
                    <img id="avatarPreview" class="rounded-circle position-absolute top-0 start-0 w-100 h-100 object-fit-cover" src="/static/images/users/default_avatar.png" alt="Profile" style="display: none;">
                  {% endif %}
                </div>
              </div>
      
              <div class="col-md-6">
                <label for="nome" class="form-label">Name</label>
                <input type="text" class="form-control" id="nome" name="nome" value="{{ user.nome }}" required>
              </div>
      
              <div class="col-md-6">
                <label for="cognome" class="form-label">Surname</label>
                <input type="text" class="form-control" id="cognome" name="cognome" value="{{ user.cognome }}" required>
              </div>
      
              <div class="col-md-6">
                <label for="telefono" class="form-label">Phone</label>
                <input type="text" class="form-control" id="telefono" name="telefono" value="{{ user.telefono }}">
              </div>
      
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" disabled>
              </div>
      
              <div class="col-12 text-center mt-4">
                <button type="submit" class="btn btn-danger px-5">
                  <i class="fa-solid fa-save me-2"></i>Save
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <script>
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarPreview = document.getElementById('avatarPreview');
      
        avatarUpload.addEventListener('change', function () {
          const file = this.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = e => {
              avatarPreview.src = e.target.result;
              avatarPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        });

        // üîÑ Supporto drag & drop
        const avatarWrapper = document.querySelector('.avatar-upload-wrapper');

        avatarWrapper.addEventListener('dragover', (e) => {
          e.preventDefault();
          avatarWrapper.classList.add('border-warning');
        });

        avatarWrapper.addEventListener('dragleave', () => {
          avatarWrapper.classList.remove('border-warning');
        });

        avatarWrapper.addEventListener('drop', (e) => {
          e.preventDefault();
          avatarWrapper.classList.remove('border-warning');
          const file = e.dataTransfer.files[0];
          if (file) {
            avatarUpload.files = e.dataTransfer.files;
            const reader = new FileReader();
            reader.onload = e => {
              avatarPreview.src = e.target.result;
              avatarPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        });
      
        document.getElementById('updateProfileForm').addEventListener('submit', function (e) {
          e.preventDefault();
          const formData = new FormData(this);
      
          fetch('/api/update_profile', {
            method: 'POST',
            body: formData
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire('‚úÖ Success', data.message, 'success');
              } else {
                Swal.fire('‚ùå Error', data.message, 'error');
              }
            })
            .catch(err => {
              Swal.fire('‚ùå Error', 'Errore durante l\'invio della richiesta', 'error');
            });
        });
      </script>

    </div>
{% endblock %}
