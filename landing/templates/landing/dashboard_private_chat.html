{% extends 'landing/base.html' %}
{% block content %}
<div class="d-flex" style="height: 100vh; overflow: hidden;">
    <!-- Sidebar inclusa -->
    <div style="width: 240px; min-width: 240px; background-color: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 100;">
      {% include 'landing/dashboard_sidebar.html' %}
    </div>
  
    <!-- Main Content -->
    <div class="flex-grow-1 p-4" style="overflow-y: auto; background: #f5f6f8;">
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <a href="/home">
        <img src="/static/images/superadmin/linkbay_logo.png" width="150px" alt="Logo">
      </a>
      <a href="/logout" class="btn btn-danger">Logout <i class="fa-solid fa-right-from-bracket"></i></a>
    </div>

    <div class="d-flex align-items-center mb-3">
      <div>
        <h4 class="mb-0">Login come: {{ user['nome'] or 'Utente' }} ğŸ‘‹</h4>
      </div>
    </div>

    <hr style="border: 0; height: 2px; background-color: red; margin: 20px 0;">

    <!-- CONTENUTI DINAMICI -->
    <div id="content9" class="content-pane" data-aos="fade-up">
      <div class="card shadow-sm border-0" style="height: 70vh;">
        <div class="card-header bg-danger text-white d-flex align-items-center">
          <i class="fa-solid fa-user-circle fa-lg me-2"></i>
          <strong>{{ target_user.nome }} {{ target_user.cognome }}</strong>
          <span class="ms-auto small">Chat privata</span>
        </div>
        <div class="card-body p-3" id="chat-messages" style="overflow-y: auto; height: calc(100% - 100px); background-color: #fff;">
          <!-- Messaggi caricati dinamicamente -->
          <div class="text-center text-muted mt-4">ğŸ•“ Inizia la conversazione...</div>
        </div>
        <div class="card-footer bg-light">
          <form id="chat-form" class="d-flex align-items-center">
            <input type="text" class="form-control me-2" id="chat-input" placeholder="Scrivi un messaggio..." autocomplete="off">
            <select id="attachment-type" class="form-select me-2" style="max-width: 220px;">
              <option value="">Nessun allegato</option>
              <option value="collab">ğŸ¤ Collaborazione</option>
              <option value="shop_sale">ğŸª Vendita Negozio</option>
              <option value="theme_sale">ğŸ¨ Vendita Tema</option>
            </select>
            <button type="submit" class="btn btn-danger"><i class="fa-solid fa-paper-plane"></i></button>
          </form>
        </div>
      </div>

    <div id="chat-container"
      data-receiver-id="{{ target_user.id }}"
      data-sender-id="{{ user.id }}">
    </div>

      <script>
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const chatBox = document.getElementById("chat-messages");
        const chatContainer = document.getElementById("chat-container");
        const receiverId = chatContainer.dataset.receiverId;
        const senderId = chatContainer.dataset.senderId;

        async function loadMessages() {
          try {
            const response = await fetch(`/api/chat/messages?user_id=${receiverId}`);
            const data = await response.json();
            chatBox.innerHTML = "";
            data.data.forEach(msg => {
              const isSent = msg.sender_id == senderId;
              let contentHtml = '';

              if (msg.attachment_url) {
                if (msg.attachment_url === 'collab') {
                  contentHtml = `<div class="bg-light border rounded p-2"><strong>ğŸ¤ Proposta di collaborazione</strong><br><button class="btn btn-sm btn-outline-success mt-2">Accetta</button></div>`;
                } else if (msg.attachment_url === 'shop_sale') {
                  contentHtml = `<div class="bg-light border rounded p-2"><strong>ğŸª Proposta di vendita negozio</strong><br><a href="/dashboard/store/${msg.shop_name}" class="btn btn-sm btn-outline-primary mt-2">Vedi negozio</a></div>`;
                } else if (msg.attachment_url === 'theme_sale') {
                  contentHtml = `<div class="bg-light border rounded p-2"><strong>ğŸ¨ Proposta di vendita tema</strong><br><a href="/dashboard/themes" class="btn btn-sm btn-outline-warning mt-2">Scopri il tema</a></div>`;
                }
              }

              const readIcon = msg.is_read ? '<i class="fa fa-check-double text-success small ms-2"></i>' : '<i class="fa fa-check text-muted small ms-2"></i>';
              const msgDiv = document.createElement("div");
              msgDiv.classList.add("mb-3", "d-flex", isSent ? "justify-content-end" : "justify-content-start");

              let baseMessage = `
                <div class="p-3 rounded ${isSent ? 'bg-danger text-white' : 'bg-light text-dark'} d-inline-block shadow-sm" style="max-width: 70%;">
                  <div>${msg.message}</div>
                  <div class="mt-2 text-end">
                    ${readIcon}
                    <small class="text-muted ms-2">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                  </div>
                </div>
              `;

              msgDiv.innerHTML = baseMessage + (contentHtml ? `<div class="mt-2">${contentHtml}</div>` : '');
              chatBox.appendChild(msgDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
          } catch (err) {
            console.error("Errore caricamento messaggi:", err);
          }
        }

        chatForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          const message = chatInput.value.trim();
          const attachment = document.getElementById("attachment-type").value;
          if (message !== "") {
            await fetch("/api/chat/send", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ receiver_id: receiverId, message, attachment_url: attachment })
            });
            chatInput.value = "";
            await loadMessages();
          }
        });

        setInterval(loadMessages, 3000);
        loadMessages();
      </script>
    </div>
  </div>
</div>
{% endblock %}
