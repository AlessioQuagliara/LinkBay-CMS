{% extends 'landing/base.html' %}
{% block content %}
<div class="d-flex" style="height: 100vh; overflow: hidden;">
    <!-- Sidebar inclusa -->
    <div style="width: 240px; min-width: 240px; background-color: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 100;">
      {% include 'landing/dashboard_sidebar.html' %}
    </div>
  
    <!-- Main Content -->
    <div class="flex-grow-1 p-4" style="overflow-y: auto; background: #f5f6f8;">
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <a href="/home">
        <img src="/static/images/superadmin/linkbay_logo.png" width="150px" alt="Logo">
      </a>
      <a href="/logout" class="btn btn-danger">Logout <i class="fa-solid fa-right-from-bracket"></i></a>
    </div>

    <div class="d-flex align-items-center mb-3">
      <div>
        <h4 class="mb-0">Login come: {{ user['nome'] or 'Utente' }} ðŸ‘‹</h4>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message | safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <hr style="border: 0; height: 2px; background-color: red; margin: 20px 0;">

    <!-- CONTENUTI DINAMICI -->
    <div id="content9" class="content-pane" >
      <h4 class="mb-3">I Miei Negozi Online</h4>
      <p class="text-muted">Gestisci o accedi ai tuoi negozi in un click.</p>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for shop in shops %}
        <div class="col">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">
              <div>
                <h5 class="card-title text-danger"><i class="fa-solid fa-store me-2"></i>{{ shop.shop_name }}</h5>
                <p class="mb-1">
                  <strong>Ruolo:</strong>
                  {% if shop.access_level == 'admin' %}
                    <span class="badge bg-danger"><i class="fa-solid fa-crown me-1"></i> Admin</span>
                  {% elif shop.access_level == 'editor' %}
                    <span class="badge bg-primary"><i class="fa-solid fa-pen-ruler me-1"></i> Editor</span>
                  {% elif shop.access_level == 'viewer'  %}
                    <span class="badge bg-secondary"><i class="fa-solid fa-eye me-1"></i> Viewer</span>
                  {% else %}
                    <span class="badge bg-warning"><i class="fa-solid fa-x me-1"></i> Non rilevato</span>
                  {% endif %}
                </p>
                <p class="mb-1"><strong>Tipologia:</strong> {{ shop.shop_type }}</p>
                <p class="mb-1">
                  <strong>Dominio:</strong>
                  {% if shop.domain %}
                    <span class="text-success">{{ shop.domain }}</span>
                  {% else %}
                    <span class="text-danger">Nessun dominio</span>
                  {% endif %}
                </p>
                {% if shop.subscription %}
                  {% if shop.subscription.plan_name == 'Freemium' %}
                    <div class="alert alert-warning py-1 px-2 mt-2 mb-0">
                      <small><i class="fa-solid fa-triangle-exclamation me-1"></i> Stai usando il piano <strong>Freemium</strong>. Limite: 1000 visitatori/mese e 50 prodotti. <a href="/subscription/select/{{ shop.shop_name }}" class="text-dark fw-bold">Aggiorna il piano</a>.</small>
                    </div>
                  {% elif shop.subscription.plan_name == 'AllIsReady' %}
                    <div class="alert alert-primary py-1 px-2 mt-2 mb-0">
                      <small><i class="fa-solid fa-circle-check me-1"></i> Piano <strong>AllIsReady</strong> attivo. Fino a 5 utenti, 600 prodotti e dominio personalizzabile.</small>
                    </div>
                  {% elif shop.subscription.plan_name == 'ProfessionalDesk' %}
                    <div class="alert alert-success py-1 px-2 mt-2 mb-0">
                      <small><i class="fa-solid fa-star me-1"></i> Piano <strong>ProfessionalDesk</strong>. Prodotti illimitati, gestione magazzino e multi-dominio attivi.</small>
                    </div>
                  {% endif %}
                {% else %}
                  <p><span class="badge bg-warning text-dark">Nessun abbonamento attivo</span></p>
                {% endif %}
              </div>
              <div class="d-flex flex-wrap gap-2 mt-3">
                  <a href="{{ url_for('auth.generate_token', shop_name=shop.shop_name) }}" target="_blank" class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-arrow-up-right-from-square me-1"></i> Accedi al Negozio
                  </a>
                  <a href="/dashboard/manage/{{ shop.shop_name }}" class="btn btn-outline-dark btn-sm">
                    <i class="fa-solid fa-wrench me-1"></i> Gestione
                  </a>
                <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteShop('{{ shop.id }}')">
                  <i class="fa-solid fa-trash me-1"></i> Elimina
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      

      <div class="mt-4 text-end">
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#createShopModal">
          <i class="fa-solid fa-plus me-1"></i> Crea Nuovo Negozio
        </button>
      </div>

      <!-- MODALE PER LA CREAZIONE DEL NEGOZIO CON STEP -->
      <div class="modal fade" id="createShopModal" tabindex="-1" aria-labelledby="createShopModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <form id="createShopForm">
              <div class="modal-header">
                <h5 class="modal-title" id="createShopModalLabel">Crea Nuovo Negozio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
              </div>
              <div class="modal-body">
                <!-- Step 1: Nome negozio + Tipologia -->
                <div id="step1">
                  <div class="mb-3">
                    <label for="shop_name" class="form-label">Nome Negozio</label>
                    <input type="text" class="form-control" id="shop_name" name="shop_name" placeholder="es. erboristeria-digitale" required>
                    <div id="shopNameHelp" class="invalid-feedback d-none">Nome giÃ  in uso o non valido. Usa solo lettere, numeri e trattini (-).</div>
                  </div>
                  <div class="mb-3">
                    <label for="shop_type" class="form-label">Tipologia</label>
                    <select class="form-select" id="shop_type" name="shop_type" required>
                      <option value="" disabled selected>Seleziona una tipologia</option>
                      <option value="ecommerce">Negozio Online</option>
                      <option value="platform">Piattaforma Online</option>
                      <option value="website">Sito Web</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="modal-footer d-flex justify-content-end">
                <button type="button" class="btn btn-success" id="finalCreateBtn" onclick="creaNegozioPerUtente()">
                  <i class="fa-solid fa-plus me-1"></i> Crea Negozio
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

    <!-- Altri contenuti dinamici qui (content2, content3, etc.) -->
    </div>
</div>
<script src="/static/js/superadmin/access.js"></script>
{% endblock %}
